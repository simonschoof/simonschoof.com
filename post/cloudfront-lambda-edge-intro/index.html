<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Pulumi, CloudFront & Lambda@Edge: Introduction - Simon Schoof</title>
<meta name=description content="Setup AWS CloudFront and AWS Lambda@Edge with Pulumi"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://simonschoof.com/css/normalize.css><link rel=stylesheet href=https://simonschoof.com/css/barebones.css><link rel=stylesheet href=https://simonschoof.com/css/custom.css><link rel=stylesheet href=https://simonschoof.com/css/prettify.css><link rel=stylesheet href=https://simonschoof.com/css/syntax.css><link rel=stylesheet href=https://simonschoof.com/css/github-prettify-theme.css><link id=prettify-dark rel=stylesheet href=https://simonschoof.com/css/github-prettify-theme-dark.css disabled><link rel=stylesheet href=https://simonschoof.com/css/fontawesome.css><link rel=stylesheet href=https://simonschoof.com/css/googlefonts-raleway.css type=text/css><link rel=alternate type=application/rss+xml href=https://simonschoof.com/post/index.xml title="My Site"><script src=https://simonschoof.com/js/site.js></script><script src=https://simonschoof.com/js/fontawesome.js></script><link rel="shortcut icon" href=https://simonschoof.com/images/favicon.png type=image/png></head><body><nav><label for=drop class=toggle><i class="fas fa-bars u-pull-right" aria-hidden=true></i> <span><i class="fas fa-anchor" aria-hidden=true></i>
Home</span></label>
<input type=checkbox id=drop><ul class=menu><li><a href=https://simonschoof.com/><span><i class="fas fa-anchor" aria-hidden=true></i>
Home</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/post/index.xml class=Members><span><i class='fa-solid fa-rss'></i> rss</span></a></li><li class=u-pull-right><a href=https://social.simonschoof.com/@connect class=Members><span><i class='fab fa-mastodon'></i> mastodon</span></a></li><li class=u-pull-right><a href=https://github.com/simonschoof class=Members><span><i class='fab fa-github'></i> github</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/post class=Members><span><i class='fas fa-list'></i> blog</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/about class=Members><span><i class='fas fa-user'></i> about</span></a></li><li class=u-pull-right><span class=toggle-theme-button-span><button id=toggle-theme-btn-id class=toggle-theme-btn title="Toggle theme" aria-hidden=true onclick=toggleTheme()><div class=toggle-theme-btn-overlay-wrap><span id=dark-theme-span class=dark-theme-span><svg class="toggle-theme-svg" fill="none" viewBox="0 3 48 48" style="overflow:visible"><path fill="#fff" d="M12 11.807c-1.2582-1.2587-2.11512-2.86216-2.46238-4.6077C9.19037 5.45375 9.36832 3.64444 10.049 2c-1.94074.38205-3.7234 1.33431-5.12001 2.735-3.905 3.905-3.905 10.237.0 14.142 3.906 3.906 10.23701 3.905 14.14301.0 1.4003-1.3965 2.3525-3.1787 2.735-5.119C20.1625 14.4385 18.3533 14.6164 16.6077 14.2692 14.8622 13.9219 13.2588 13.0651 12 11.807v0z"/></svg></span>
<span id=light-theme-span class=light-theme-span><svg class="toggle-theme-svg" fill="none" viewBox="0 3 48 48" style="overflow:visible"><path d="M6.995 12c0 2.761 2.246 5.007 5.007 5.007 2.761.0 5.007-2.246 5.007-5.007s-2.246-5.007-5.007-5.007C9.241 6.993 6.995 9.239 6.995 12zM11 19h2v3H11V19zM11 2h2V5H11V2zM2 11H5v2H2V11zm17 0h3v2H19V11z" fill="#fff"/><path d="M5.63702 19.778l-1.414-1.414 2.121-2.121 1.414 1.414-2.121 2.121z" fill="#fff"/><path d="M16.242 6.34405l2.122-2.122 1.414 1.414-2.122 2.122-1.414-1.414z" fill="#fff"/><path d="M6.34402 7.75902l-2.121-2.122 1.415-1.414 2.12 2.122-1.414 1.414z" fill="#fff"/><path d="M19.778 18.3639l-1.414 1.414-2.122-2.122 1.414-1.414 2.122 2.122z" fill="#fff"/></svg></span></div></button></span></li></ul></nav><div class="section hero"><div class=container><h1 class="section-heading section-sized-heading">Pulumi, CloudFront & Lambda@Edge: Introduction</h1><i class="far fa-calendar"></i> 2022-06-28,
<i class="far fa-clock"></i> Reading Time: 4 minutes</h6></div></div><div class="section main"><div class="row content"><article><p>After writing my <a href=/post/first-steps-fsharp/>first article about my first steps in F#</a>, I thought about what project I would like to tackle next. I decided to continue with <a href=https://fsharp.org/ rel="noopener noreferrer">F#</a>, but in a different environment. I want to use F# with <a href=https://www.pulumi.com/ rel="noopener noreferrer">Pulumi</a> to set up <a href=https://aws.amazon.com/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/ rel="noopener noreferrer">CloudFront and Lambda@Edge to resize images on the fly</a>.</p><p>So I followed <a href=https://aws.amazon.com/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/ rel="noopener noreferrer">Amazon`s blog post</a> where they set up a simple service to resize images with CloudFront and Lambda@Edge, but used CloudFormation instead of Pulumi. I also simplified the Lambda@Edge functions by reducing the functionality. Finally, I also use TypeScript to write the Lambda@Edge functions instead of JavaScript.</p><p>Since the original blog post from Amazon is quite long, I decided to write a small series of articles on setting up CloudFront and Lambda@Edge with Pulumi.</p><p>In this article we give a brief introduction to CloudFront and Lambda@Edge. In the second part, we will show how to set up the infrastructure with Pulumi. In the third part, we will implement the resizing features using TypeScript. Last but not least, we will show how to deploy the resizing service on AWS using Pulumi and GitHub Actions.
All the code can be found in <a href=https://github.com/simonschoof/lambda-at-edge-example rel="noopener noreferrer">this Git repository on Github</a>.</p><h3 id=cloudfront-and-lambdaedge>CloudFront and Lambda@Edge</h3><p><a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html rel="noopener noreferrer">CloudFront is a content delivery network (CDN) service provided by Amazon</a>. It can be used to distribute static and dynamic content, such as .html, .css, .js, and image files, to end users. To ensure that the content can be delivered to the end users with the lowest latency, CloudFront uses a combination of network and cache servers located in multiple data centers around the world. One such data center is called a CloudFront edge location. When an end user now tries to request content from CloudFront, CloudFront sends the request to the CloudFront edge location that is closest to the end user and tries to get the content from there.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> If the content is not available in the CloudFront edge location, CloudFront sends the request to the CloudFront origin, which can be an Amazon Simple Storage Service (Amazon S3) bucket or a custom origin. CloudFront then stores the content at the CloudFront edge location. The content is then delivered to the end user. CloudFront&rsquo;s cache has <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/ConfiguringCaching.html rel="noopener noreferrer">a variety of options</a> to control the caching behavior of the content.
Configuring CloudFront&rsquo;s cache behavior is the point at which a Lambda function can be connected to CloudFront, becoming a Lambda@Edge function. There are four trigger points in CloudFront where the request or response can be changed:</p><ol><li>Viewer Request -> Executes on a viewer request before checking the cache</li><li>Origin Request -> Executes on an origin request before sending the request to the origin</li><li>Origin Response -> Executes on an origin response before sending the response to the cache</li><li>Viewer Response -> Executes on a viewer response before sending the response to the user</li></ol><figure2 class=cloudfront-trigger-points><img src=https://simonschoof.com/images/cloudfront_trigger_points.svg alt="CloudFront trigger points. Modified original image"><figcaption><p>CloudFront trigger points. Modified <a href=https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2018/02/01/1.png rel="noopener noreferrer">original image</a></p></figcaption></figure2><p>For more information on trigger points, see the original post from <a href=https://aws.amazon.com/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/ rel="noopener noreferrer">Amazon</a> and the <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-cloudfront-trigger-events.html rel="noopener noreferrer">Developer`s Guide</a>.</p><p>For our example, we will extend the CloudFront behavior by associating Lambda functions with the trigger points of the viewer request and the origin response. In the viewer request, we will check if the resize parameters are set in the query string and if they are within a certain limit. If the resize parameters are correct, it checks if the image is already cached at the CloudFront Edge location. If the image is cached, the cached image is returned. If the image is not cached, we send the request to the origin, resize the image, and store it in the CloudFront edge location cache. As mentioned earlier, the example here is a bit simpler than the one provided by Amazon. For example, we will not store the resized images in the S3 bucket. Before starting with CloudFront and Lambda@Edge, you should take a look at the <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/edge-functions-restrictions.html rel="noopener noreferrer">restrictions</a> and <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cloudfront-limits.html#limits-lambda-at-edge rel="noopener noreferrer">quotas</a> on Lambda@Edge functions, to check if Lambda@Edge is sufficient for the use case at hand.</p><figure2 class=cloudfront-lambda-workflow><img src=https://simonschoof.com/images/cloudfront_lambda_workflow.svg alt="CloudFront lambda workflow. Modified original image"><figcaption><p>CloudFront lambda workflow. Modified <a href=https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2018/02/20/Social-Media-Image-Resize-Images.png rel="noopener noreferrer">original image</a></p></figcaption></figure2><p>In the
<a href=https://simonschoof.com/post/cloudfront-lambda-edge-infrastructure/>next part</a>
, we will set up the necessary AWS infrastructure using <a href=https://www.pulumi.com/ rel="noopener noreferrer">Pulumi</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>In May 2021, Amazon introduced <a href=https://aws.amazon.com/blogs/aws/introducing-cloudfront-functions-run-your-code-at-the-edge-with-low-latency-at-any-scale/ rel="noopener noreferrer">CloudFront Functions</a>, which allows lightweight functions to run directly at the edge location instead of in the regional edge cache. CloudFront Functions are cheaper and have a higer performance than Lambda@Edge functions, but are limited to the use case of lightweight web request processing and are subject to even tighter constraints and quotas.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><footer><span class=copyright>Build with <a href=https://gohugo.io/ title=hugo alt=hugo target=_blank>hugo</a> & <span class=emojify>❤️</span>
| Theme: Based on <a href=https://github.com/aanupam23/hugo-sugoi title=hugo-sugoi alt=hugo-sugoi target=_blank>hugo-sugoi</a>
extended by <a href=https://github.com/simonschoof/hugo-sugoi title="my theme" alt="my theme" target=_blank>me</a>.<br>&copy; 2024 Simon Schoof
| <a href=https://simonschoof.com/imprint title=Imprint alt=Imprint>Imprint</a>
| <a href=https://simonschoof.com/privacy title=Privacy alt=Privacy>Privacy</a>
| <a rel=me href=https://social.simonschoof.com/@connect></a></span></footer></body></html>