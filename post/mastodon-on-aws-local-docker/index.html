<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Mastodon on AWS: Running locally - Simon Schoof</title>
<meta name=description content="Running Mastodon locally using Docker and Docker Compose"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://simonschoof.com/css/normalize.css><link rel=stylesheet href=https://simonschoof.com/css/barebones.css><link rel=stylesheet href=https://simonschoof.com/css/custom.css><link rel=stylesheet href=https://simonschoof.com/css/prettify.css><link rel=stylesheet href=https://simonschoof.com/css/syntax.css><link rel=stylesheet href=https://simonschoof.com/css/github-prettify-theme.css><link id=prettify-dark rel=stylesheet href=https://simonschoof.com/css/github-prettify-theme-dark.css disabled><link rel=stylesheet href=https://simonschoof.com/css/fontawesome.css><link rel=stylesheet href=https://simonschoof.com/css/googlefonts-raleway.css type=text/css><link rel=alternate type=application/rss+xml href=https://simonschoof.com/post/index.xml title="My Site"><script src=https://simonschoof.com/js/site.js></script><script src=https://simonschoof.com/js/fontawesome.js></script><link rel="shortcut icon" href=https://simonschoof.com/images/favicon.png type=image/png></head><body><nav><label for=drop class=toggle><i class="fas fa-bars u-pull-right" aria-hidden=true></i> <span><i class="fas fa-anchor" aria-hidden=true></i>
Home</span></label>
<input type=checkbox id=drop><ul class=menu><li><a href=https://simonschoof.com/><span><i class="fas fa-anchor" aria-hidden=true></i>
Home</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/post/index.xml class=Members><span><i class='fa-solid fa-rss'></i> rss</span></a></li><li class=u-pull-right><a href=https://social.simonschoof.com/@connect class=Members><span><i class='fab fa-mastodon'></i> mastodon</span></a></li><li class=u-pull-right><a href=https://github.com/simonschoof class=Members><span><i class='fab fa-github'></i> github</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/post class=Members><span><i class='fas fa-list'></i> blog</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/about class=Members><span><i class='fas fa-user'></i> about</span></a></li><li class=u-pull-right><span class=toggle-theme-button-span><button id=toggle-theme-btn-id class=toggle-theme-btn title="Toggle theme" aria-hidden=true onclick=toggleTheme()><div class=toggle-theme-btn-overlay-wrap><span id=dark-theme-span class=dark-theme-span><svg class="toggle-theme-svg" fill="none" viewBox="0 3 48 48" style="overflow:visible"><path fill="#fff" d="M12 11.807c-1.2582-1.2587-2.11512-2.86216-2.46238-4.6077C9.19037 5.45375 9.36832 3.64444 10.049 2c-1.94074.38205-3.7234 1.33431-5.12001 2.735-3.905 3.905-3.905 10.237.0 14.142 3.906 3.906 10.23701 3.905 14.14301.0 1.4003-1.3965 2.3525-3.1787 2.735-5.119C20.1625 14.4385 18.3533 14.6164 16.6077 14.2692 14.8622 13.9219 13.2588 13.0651 12 11.807v0z"/></svg></span>
<span id=light-theme-span class=light-theme-span><svg class="toggle-theme-svg" fill="none" viewBox="0 3 48 48" style="overflow:visible"><path d="M6.995 12c0 2.761 2.246 5.007 5.007 5.007 2.761.0 5.007-2.246 5.007-5.007s-2.246-5.007-5.007-5.007C9.241 6.993 6.995 9.239 6.995 12zM11 19h2v3H11V19zM11 2h2V5H11V2zM2 11H5v2H2V11zm17 0h3v2H19V11z" fill="#fff"/><path d="M5.63702 19.778l-1.414-1.414 2.121-2.121 1.414 1.414-2.121 2.121z" fill="#fff"/><path d="M16.242 6.34405l2.122-2.122 1.414 1.414-2.122 2.122-1.414-1.414z" fill="#fff"/><path d="M6.34402 7.75902l-2.121-2.122 1.415-1.414 2.12 2.122-1.414 1.414z" fill="#fff"/><path d="M19.778 18.3639l-1.414 1.414-2.122-2.122 1.414-1.414 2.122 2.122z" fill="#fff"/></svg></span></div></button></span></li></ul></nav><div class="section hero"><div class=container><h1 class="section-heading section-sized-heading">Mastodon on AWS: Running locally</h1><i class="far fa-calendar"></i> 2023-05-31,
<i class="far fa-clock"></i> Reading Time: 11 minutes</h6></div></div><div class="section main"><div class="row content"><article><p>This post is the first part of a series of two articles about running a <a href=https://joinmastodon.org/ rel="noopener noreferrer">Mastodon</a> instance on AWS with ECS and Fargate. To familiarize myself with Mastodon and its configuration, I decided to first run Mastodon locally using <a href=https://docs.docker.com/compose/ rel="noopener noreferrer">Docker Compose</a>. This post will describe the steps to run Mastodon locally with Docker Compose. The second part will cover the steps to run Mastodon on AWS using ECS and Fargate.
The code for this part can be found <a href=https://github.com/simonschoof/mastodon-aws rel="noopener noreferrer">here</a>.</p><h3 id=introduction>Introduction</h3><p>Since I was never a big fan of the existing social media platforms, I was looking for an alternative for a while. I came across Mastodon and got interested in it and the idea of <a href=https://knightcolumbia.org/content/protocols-not-platforms-a-technological-approach-to-free-speech rel="noopener noreferrer">building protocols instead of platforms</a>. When I was looking for Mastodon instances, I came up with the idea of hosting my own instance. I also thought it might be a good next project to write a blog post about. Since I already used AWS for my last project, I thought it might be interesting to run Mastodon on AWS as well.</p><p>Before I start with the AWS part, I wanted to get familiar with Mastodon and its configuration. Therefore, I decided to run Mastodon locally with Docker Compose for now. In the next sections, I will describe the steps to run Mastodon locally with Docker Compose. To get Mastodon running with Docker Compose, I am grateful to have found the following blog posts by Ben Tasker and Peter Babič, which helped me a lot:</p><ul><li><a href=https://www.bentasker.co.uk/posts/blog/general/running-mastodon-in-docker-compose.html#self_hosting rel="noopener noreferrer">https://www.bentasker.co.uk/posts/blog/general/running-mastodon-in-docker-compose.html#self_hosting</a>.</li><li><a href=https://peterbabic.dev/blog/running-mastodon-with-docker-compose/ rel="noopener noreferrer">https://peterbabic.dev/blog/running-mastodon-with-docker-compose/</a></li></ul><p>In the next section, I describe the steps to customize the Docker Compose file to run Mastodon in a local setup for exploration and testing purposes.</p><h3 id=adjusting-to-run-locally>Adjusting to run locally</h3><p>Since we only want to run Mastodon locally for research and testing purposes, we will make some small changes to the Docker Compose file and Nginx configuration, and deviate somewhat from the setup described in the blog posts by <a href=https://www.bentasker.co.uk/posts/blog/general/running-mastodon-in-docker-compose.html#self_hosting rel="noopener noreferrer">Ben Tasker</a> and <a href=https://peterbabic.dev/blog/running-mastodon-with-docker-compose/ rel="noopener noreferrer">Peter Babič</a>.</p><h5 id=docker-compose-and-env-file>Docker Compose and .env file</h5><p>First, we get the Docker Compose file from the <a href=https://github.com/mastodon/mastodon/blob/main/docker-compose.yml rel="noopener noreferrer">Mastodon repository</a>. There is no need to clone the entire repository, as the Docker Compose file is the only file we need from the repository. Of course, you can also clone the repository and copy the Docker Compose file from there.</p><p>The second file we need is the <code>.env.development</code> file. This file contains the environment variables for the Mastodon web, streaming, and Sidekiq service definitions in the Docker Compose file. We can start with an empty file and add the variables we need later. Inside a shell, you can create the file with the following command: <code>touch .env.development</code>.</p><p>The environment part of the .env file determines the Rails environment. We will set it to <code>development</code> since we want to run Mastodon locally for exploration and testing purposes. Therefore, we need to replace <code>.env.production</code> with <code>.env.development</code> in the Docker Compose file.</p><h5 id=remove-build-statements>Remove build statements</h5><p>In the second step, we need to remove the build statements from the Docker Compose file, since we will use the prebuilt images from the <a href=https://hub.docker.com/r/tootsuite/mastodon rel="noopener noreferrer">Docker Hub</a> instead of building the images locally.
Simply replace the build statement <code>build:.</code> with <code>image: tootsuite/mastodon:v4.1.1</code> in the Docker Compose file. The latest image version at the time of writing is v4.1.1.</p><h5 id=remove-networks>Remove networks</h5><p>In a third step, we need to remove the internal and external networks from the Docker Compose file, since it is not necessary to distinguish between internal and external networks when running locally only.
Simply remove the networks from the service definitions and the Networks section in the Docker Compose file.</p><p>Remove the following lines from the service definitions</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>internal_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>external_network</span><span class=w>
</span></span></span></code></pre></div><p>and the networks section at the end of the Docker Compose file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>external_network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>internal_network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>I also removed the local host IP, <code>127.0.0.1</code>, before the port mappings and deleted the comments for the Elasticsearch cluster and the hidden services federation configuration. This was probably not necessary, but I thought it would be cleaner to remove them.</p><h5 id=add-mailcatcher>Add Mailcatcher</h5><p>To be able to send and receive emails locally, we can add <a href=https://mailcatcher.me/ rel="noopener noreferrer">Mailcatcher</a> to the Docker Compose file. Mailcatcher is a simple SMTP server that intercepts all messages sent to it and displays them in a web interface. With Mailcatcher, we can send emails locally on port 1025 and receive them on port 1080.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>mailcatcher</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>schickling/mailcatcher</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mastodon-mailcatcher</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1025</span><span class=p>:</span><span class=m>1025</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1080</span><span class=p>:</span><span class=m>1080</span><span class=w>
</span></span></span></code></pre></div><h5 id=add-minio>Add Minio</h5><p>To be able to upload media files to a local S3-compatible storage, we can add <a href=https://min.io/ rel="noopener noreferrer">Minio</a> to the Docker Compose file. Minio is an open source object storage server that is compatible with the Amazon S3 cloud storage service. With Minio, we can upload media files locally on port 9000 and access the Minio console on port 9001. I was unable to use a local AWS S3 mock server because the AWS S3 client used by Mastodon appears to be hardwired to use the AWS S3 API endpoints. Therefore, I had to use Minio instead.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>minio</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>minio/minio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;9000:9000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;9001:9001&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>minio_storage:/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>MINIO_ROOT_USER</span><span class=p>:</span><span class=w> </span><span class=l>minio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>MINIO_ROOT_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>minio123</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>server --console-address &#34;:9001&#34; /data</span><span class=w>
</span></span></span></code></pre></div><h5 id=adjust-nginx-configuration>Adjust Nginx configuration</h5><p>In the last step of the preparation we will customize the Nginx configuration to run Mastodon locally. We will use the Nginx configuration provided by <a href=https://www.bentasker.co.uk/posts/blog/general/running-mastodon-in-docker-compose.html#self_hosting rel="noopener noreferrer">Ben Tasker</a> and configure it to run Mastodon on the local domain <code>social.localhost</code> with <a href=https://letsencrypt.org/docs/certificates-for-localhost/ rel="noopener noreferrer">self-signed certificates for this local domain</a>. For this purpose I created a new folder <code>nginx</code> and added the following subfolders:</p><ul><li><code>conf.d</code> - contains the Nginx configuration files</li><li><code>certs</code> - contains the self-signed certificates</li><li><code>tmp</code> - contains the Nginx temporary files.</li><li><code>lebase</code> - don&rsquo;t know what this is for. Just copied it from Ben Tasker&rsquo;s setup.</li></ul><p>The folders are mounted as volumes in the Nginx container. The Nginx container is configured as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mastodon-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>443</span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>80</span><span class=p>:</span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./nginx/tmp:/var/run/nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./nginx/conf.d:/etc/nginx/conf.d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./nginx/certs:/etc/letsencrypt/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./nginx/lebase:/lebase</span><span class=w>
</span></span></span></code></pre></div><p>To create the self-signed certificates, we can run the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl req -x509 -out social.localhost.crt -keyout social.localhost.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -newkey rsa:2048 -nodes -sha256 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -subj <span class=s1>&#39;/CN=social.localhost&#39;</span> -extensions EXT -config &lt;<span class=o>(</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   <span class=nb>printf</span> <span class=s2>&#34;[dn]\nCN=social.localhost\n[req]\ndistinguished_name = dn\n[EXT]\nsubjectAltName=DNS:social.localhost\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth&#34;</span><span class=o>)</span>
</span></span></code></pre></div><p>The created certificates are then placed in the folder <code>nginx/certs</code>.
The Nginx configuration file is called <code>mastodon.development.conf</code> and is located in the <code>nginx/conf.d</code> folder and looks like this:</p><pre tabindex=0><code class=language-conf data-lang=conf>server {
        listen 80;
        listen   [::]:80; 

        root /lebase; 
        index index.html index.htm;

        server_name social.localhost;

        location ~ /.well-known/acme-challenge {
            try_files $uri $uri/ =404;
        }

        location / {
                return 301 https://$server_name$request_uri;                
        }
}

server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        root /mnt/none;
        index index.html index.htm;

        server_name social.localhost;

        ssl on;

        ssl_certificate      /etc/letsencrypt/social.localhost.crt;
        ssl_certificate_key  /etc/letsencrypt/social.localhost.key;

        ssl_session_timeout  5m;
        ssl_prefer_server_ciphers On;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

        absolute_redirect off;
        server_name_in_redirect off;

        error_page 404 /404.html;
        error_page 410 /410.html;

        location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto https;

            proxy_pass http://web:3000;
        }

        location ^~ /api/v1/streaming {
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto https;

            proxy_pass http://streaming:4000;

            proxy_buffering off;
            proxy_redirect off;
            proxy_http_version 1.1;
            tcp_nodelay on;
        }
}
</code></pre><p>The main parts of the Nginx configuration file are doing the following:</p><ul><li>Redirects all HTTP requests to HTTPS</li><li>Serves the Mastodon web application on port 3000</li><li>Serves the Mastodon streaming API on port 4000. The path for the streaming API is <code>/api/v1/streaming</code></li></ul><h3 id=prepare-and-run-mastodon>Prepare and run Mastodon</h3><p>Now that the preparations are complete, we can set up the Mastodon instance. To summarize, the following must be in place:</p><ul><li>The customized Docker Compose file.</li><li>An (empty) <code>.env.development</code> file.</li><li>The Nginx configuration file and the self-signed certificates.</li></ul><p>As also mentioned by Peter Babič, this part is a bit tricky, but we will see that it is a bit easier if we just want to run Mastodon on a local domain instead of running it in a Docker environment in production.</p><p>To set up the Mastodon instance, we need to run the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose run --rm web bundle <span class=nb>exec</span> rake mastodon:setup <span class=nv>DISABLE_DATABASE_ENVIRONMENT_CHECK</span><span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><p>I added the <code>DISABLE_DATABASE_ENVIRONMENT_CHECK=1</code> option to the command to be able to re-run the command and recreate the database if I made a mistake. This is not recommended for production, but it is fine for a local setup.</p><p>The command asks you a few questions and then sets up the Mastodon instance. We will go through the questions and answers I used to set up Mastodon on the local domain <code>social.localhost</code>. I have split the questions into several sections for ease of reading and to be able to add comments on the different parts of Mastodon setup.</p><div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th>Prompt</th><th>Answer</th><th>Default</th></tr></thead><tbody><tr><td style=word-wrap:break-word>Domain name</td><td style=word-wrap:break-word>social.localhost</td><td style=word-wrap:break-word>n/a</td></tr><tr><td style=word-wrap:break-word>Do you want to enable single user mode</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>n</td></tr><tr><td style=word-wrap:break-word>Are you using Docker to run Mastodon</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>y</td></tr></tbody></table></tbody></table></div></div></div><p>I have enabled single user mode because I want to run my own instance that way for now. I&rsquo;m thinking about opening it up to other users later, but for now I want to keep it to myself. You can, of course, run Mastodon locally in multi-user mode. The next step is to configure the database and Redis.</p><div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th>Prompt</th><th>Answer</th><th>Default</th></tr></thead><tbody><tr><td style=word-wrap:break-word>PostgreSQL host</td><td style=word-wrap:break-word>db</td><td style=word-wrap:break-word>db</td></tr><tr><td style=word-wrap:break-word>PostgreSQL port</td><td style=word-wrap:break-word>5432</td><td style=word-wrap:break-word>5432</td></tr><tr><td style=word-wrap:break-word>Name of PostgreSQL database</td><td style=word-wrap:break-word>mastodon</td><td style=word-wrap:break-word>postgres</td></tr><tr><td style=word-wrap:break-word>Name of PostgreSQL user</td><td style=word-wrap:break-word>postgres</td><td style=word-wrap:break-word>postgres</td></tr><tr><td style=word-wrap:break-word>Password of PostgreSQL user</td><td style=word-wrap:break-word></td><td style=word-wrap:break-word></td></tr></tbody></table></tbody></table></div></div></div><p>The PostgreSQL setup is very simple. After entering the PostgreSQL setup values, you should see the following output: <code>Database configuration works! 🎆</code></p><div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th>Prompt</th><th>Answer</th><th>Default</th></tr></thead><tbody><tr><td style=word-wrap:break-word>Redis host</td><td style=word-wrap:break-word>redis</td><td style=word-wrap:break-word>redis</td></tr><tr><td style=word-wrap:break-word>Redis port</td><td style=word-wrap:break-word>6379</td><td style=word-wrap:break-word>6379</td></tr><tr><td style=word-wrap:break-word>Redis password</td><td style=word-wrap:break-word></td><td style=word-wrap:break-word></td></tr></tbody></table></tbody></table></div></div></div><p>The Redis setup is also simple. After entering the values for the Redis setup, you should see the following output: <code>Redis configuration works! 🎆</code></p><p>The next step is to configure the file storage. I use Minio as the S3 compatible file store. Here I take advantage of how Docker networks work. It&rsquo;s not very elegant, but it works for now. I&rsquo;m sure there is a better way to set up and run a local S3 compatible file store for use with Mastodon.</p><div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th>Prompt</th><th>Answer</th><th>Default</th></tr></thead><tbody><tr><td style=word-wrap:break-word>Do you want to store uploaded files on the cloud?</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>n</td></tr><tr><td style=word-wrap:break-word>Provider</td><td style=word-wrap:break-word>Choose Minio from the list</td><td style=word-wrap:break-word>List choice</td></tr><tr><td style=word-wrap:break-word>Minio endpoint URL</td><td style=word-wrap:break-word>http://minio:9000</td><td style=word-wrap:break-word></td></tr><tr><td style=word-wrap:break-word>Minio bucket name</td><td style=word-wrap:break-word>files.social.localhost</td><td style=word-wrap:break-word>files.<code>domain</code></td></tr><tr><td style=word-wrap:break-word>Minio access key</td><td style=word-wrap:break-word>minio</td><td style=word-wrap:break-word>minio</td></tr><tr><td style=word-wrap:break-word>Minio secret key</td><td style=word-wrap:break-word>minio123</td><td style=word-wrap:break-word>minio123</td></tr><tr><td style=word-wrap:break-word>Do you want to access the uploaded files from your own domain</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>y</td></tr></tbody></table></tbody></table></div></div></div><p>After the file store is configured, we need to configure the SMTP server. I use Mailcatcher to intercept all outgoing emails.</p><div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th>Prompt</th><th>Answer</th><th>Default</th></tr></thead><tbody><tr><td style=word-wrap:break-word>Do you want to send e-mails from localhost</td><td style=word-wrap:break-word>n</td><td style=word-wrap:break-word>n</td></tr><tr><td style=word-wrap:break-word>SMTP server</td><td style=word-wrap:break-word>mailcatcher</td><td style=word-wrap:break-word></td></tr><tr><td style=word-wrap:break-word>SMTP port</td><td style=word-wrap:break-word>1025</td><td style=word-wrap:break-word>587</td></tr><tr><td style=word-wrap:break-word>SMTP username</td><td style=word-wrap:break-word></td><td style=word-wrap:break-word></td></tr><tr><td style=word-wrap:break-word>SMTP password</td><td style=word-wrap:break-word></td><td style=word-wrap:break-word></td></tr><tr><td style=word-wrap:break-word>SMTP authentication</td><td style=word-wrap:break-word>plain</td><td style=word-wrap:break-word>plain</td></tr><tr><td style=word-wrap:break-word>SMTP OpenSSL verify mode</td><td style=word-wrap:break-word>none</td><td style=word-wrap:break-word>List choice</td></tr><tr><td style=word-wrap:break-word>Enable STARTTLS</td><td style=word-wrap:break-word>auto</td><td style=word-wrap:break-word>List choice</td></tr><tr><td style=word-wrap:break-word>E-mail address to send e-mails &ldquo;from&rdquo;</td><td style=word-wrap:break-word>Mastodon &lt;notifications@social.localhost></td><td style=word-wrap:break-word>Mastodon &lt;notifications@<code>domain</code>></td></tr><tr><td style=word-wrap:break-word>Send a test e-mail with this configuration right now</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>y</td></tr><tr><td style=word-wrap:break-word>Send a test e-mail to</td><td style=word-wrap:break-word><a href=mailto:mail@social.localhost>mail@social.localhost</a></td><td style=word-wrap:break-word></td></tr></tbody></table></tbody></table></div></div></div><p>The last question of the SMTP server configuration is sending a test email, which we should have answered yes. If everything is configured correctly, we can open the Mailcatcher web interface on <code>http://localhost:1080</code> and see the test email.</p><figure2 class=mastodon-mailcatcher><img src=https://simonschoof.com/images/mastodon-mailcatcher.webp alt="Mastodon test email"><figcaption><p>Mastodon test email</p></figcaption></figure2><p>The second to last step is to save the config to the <code>.env.production</code> file in the Docker container. This is done by answering the following question:<div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th>Prompt</th><th>Answer</th><th>Default</th></tr></thead><tbody><tr><td style=word-wrap:break-word>Save configuration</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>y</td></tr></tbody></table></tbody></table></div></div></div></p><p>If you answered &lsquo;yes&rsquo; to the last question, the configuration will be saved in the <code>.env.production</code> file in the currently running Docker container and also displayed on the screen. We can now copy the output configuration from the screen to the <code>.env.development</code> file on our local machine. The output configuration should look something like the text below. For clarity, I have removed the secret values.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># Generated with mastodon:setup on 2023-03-19 21:16:41 UTC</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Some variables in this file will be interpreted differently whether you are</span>
</span></span><span class=line><span class=cl><span class=c1># using docker-compose or not.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>LOCAL_DOMAIN</span><span class=o>=</span>social.localhost
</span></span><span class=line><span class=cl><span class=nv>SINGLE_USER_MODE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>SECRET_KEY_BASE</span><span class=o>=</span>&lt;secret&gt;
</span></span><span class=line><span class=cl><span class=nv>OTP_SECRET</span><span class=o>=</span>&lt;secret&gt;
</span></span><span class=line><span class=cl><span class=nv>VAPID_PRIVATE_KEY</span><span class=o>=</span>&lt;secret&gt;
</span></span><span class=line><span class=cl><span class=nv>VAPID_PUBLIC_KEY</span><span class=o>=</span>&lt;secret&gt;
</span></span><span class=line><span class=cl><span class=nv>DB_HOST</span><span class=o>=</span>db
</span></span><span class=line><span class=cl><span class=nv>DB_PORT</span><span class=o>=</span><span class=m>5432</span>
</span></span><span class=line><span class=cl><span class=nv>DB_NAME</span><span class=o>=</span>mastodon
</span></span><span class=line><span class=cl><span class=nv>DB_USER</span><span class=o>=</span>postgres
</span></span><span class=line><span class=cl><span class=nv>DB_PASS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>REDIS_HOST</span><span class=o>=</span>redis
</span></span><span class=line><span class=cl><span class=nv>REDIS_PORT</span><span class=o>=</span><span class=m>6379</span>
</span></span><span class=line><span class=cl><span class=nv>REDIS_PASSWORD</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>S3_ENABLED</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>S3_PROTOCOL</span><span class=o>=</span>http
</span></span><span class=line><span class=cl><span class=nv>S3_REGION</span><span class=o>=</span>us-east-1
</span></span><span class=line><span class=cl><span class=nv>S3_ENDPOINT</span><span class=o>=</span>http://minio:9000
</span></span><span class=line><span class=cl><span class=nv>S3_HOSTNAME</span><span class=o>=</span>minio:9000
</span></span><span class=line><span class=cl><span class=nv>S3_BUCKET</span><span class=o>=</span>files.social.localhost
</span></span><span class=line><span class=cl><span class=nv>AWS_ACCESS_KEY_ID</span><span class=o>=</span>minio
</span></span><span class=line><span class=cl><span class=nv>AWS_SECRET_ACCESS_KEY</span><span class=o>=</span>minio123
</span></span><span class=line><span class=cl><span class=nv>S3_ALIAS_HOST</span><span class=o>=</span>localhost:9000/files.social.localhost
</span></span><span class=line><span class=cl><span class=nv>SMTP_SERVER</span><span class=o>=</span>mailcatcher
</span></span><span class=line><span class=cl><span class=nv>SMTP_PORT</span><span class=o>=</span><span class=m>1025</span>
</span></span><span class=line><span class=cl><span class=nv>SMTP_LOGIN</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>SMTP_PASSWORD</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>SMTP_AUTH_METHOD</span><span class=o>=</span>plain
</span></span><span class=line><span class=cl><span class=nv>SMTP_OPENSSL_VERIFY_MODE</span><span class=o>=</span>none
</span></span><span class=line><span class=cl><span class=nv>SMTP_ENABLE_STARTTLS</span><span class=o>=</span>auto
</span></span><span class=line><span class=cl><span class=nv>SMTP_FROM_ADDRESS</span><span class=o>=</span>Mastodon &lt;notifications@social.localhost&gt;
</span></span></code></pre></div><p>The final step in setting up Mastodon is to prepare the database and create an admin user.<div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th>Prompt</th><th>Answer</th><th>Default</th></tr></thead><tbody><tr><td style=word-wrap:break-word>Prepare the database now</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>y</td></tr><tr><td style=word-wrap:break-word>Do you want to create an admin user straight away</td><td style=word-wrap:break-word>y</td><td style=word-wrap:break-word>y</td></tr><tr><td style=word-wrap:break-word>Username</td><td style=word-wrap:break-word>admin</td><td style=word-wrap:break-word>admin</td></tr><tr><td style=word-wrap:break-word>E-mail</td><td style=word-wrap:break-word><a href=mailto:admin@social.localhost>admin@social.localhost</a></td><td style=word-wrap:break-word></td></tr></tbody></table></tbody></table></div></div></div></p><p>After preparing the database and creating the admin user, we should see the following output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>You can login with the password: &lt;generated password&gt;
</span></span><span class=line><span class=cl>You can change your password once you login.
</span></span></code></pre></div><p>Copy the generated password and save it somewhere. We will need it in a minute to log in to the Mastodon instance.</p><p>To start Mastodon, we just need to run <code>docker-compose up</code> and we should be able to access the Mastodon instance at <code>https://social:localhost</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. We can log in with the username <code>admin</code> and the password generated earlier.</p><figure2 class=mastodon-running-locally><img src=https://simonschoof.com/images/mastodon-running-locally.webp alt="Mastodon running on social.localhost"><figcaption><p>Mastodon running on social.localhost</p></figcaption></figure2><p>After logging in, we can change the password of our admin user, add an avatar and a header image and write our first toots. After uploading some images, we can see that they are not displayed on Mastodon. This is because Minio uses a Content Security Policy (CSP) that prevents <a href=https://github.com/minio/minio/blob/6c11dbffd53dffd439d198f4b44e423d3e37e746/cmd/generic-handlers.go#L545 rel="noopener noreferrer">mixed (HTTP / HTTPS content)</a>. As a workaround, I temporarily installed the <a href=https://chrome.google.com/webstore/detail/disable-content-security/ieelmcmcagommplceebfedjlakkhpden/related rel="noopener noreferrer">Disable Content Security extension</a> in my Chromium browser. After disabling the CSP on the Mastodon site, we can see the images.</p><figure2 class=mastodon-first-toot><img src=https://simonschoof.com/images/mastodon-mastodon.webp alt="Mastodon first toots"><figcaption><p>Mastodon first toots</p></figcaption></figure2><p>We can then verify that the images are stored on the Minio instance by opening the Minio web interface to <code>http://localhost:9000</code> and checking the <code>files.social.localhost</code> bucket.</p><figure2 class=mastodon-minio><img src=https://simonschoof.com/images/mastodon-minio-bucket.webp alt="Local Minio bucket"><figcaption><p>Local Minio bucket</p></figcaption></figure2><p>We can also see the path of the file when we open one of the images in the browser.</p><figure2 class=mastodon-minio><img src=https://simonschoof.com/images/mastodon-minio-filepath.webp alt="Image file path for local Minio bucket"><figcaption><p>Image file path for local Minio bucket</p></figcaption></figure2><p>In the
<a href=https://simonschoof.com/post/mastodon-on-aws-setup/>next part</a>
, we show how to deploy Mastodon on AWS using Pulumi.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>You have to disable the security warning in your browser to be able to access the Mastodon instance. This is because we are using a self-signed certificate.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><footer><span class=copyright>Build with <a href=https://gohugo.io/ title=hugo alt=hugo target=_blank>hugo</a> & <span class=emojify>❤️</span>
| Theme: Based on <a href=https://github.com/aanupam23/hugo-sugoi title=hugo-sugoi alt=hugo-sugoi target=_blank>hugo-sugoi</a>
extended by <a href=https://github.com/simonschoof/hugo-sugoi title="my theme" alt="my theme" target=_blank>me</a>.<br>&copy; 2024 Simon Schoof
| <a href=https://simonschoof.com/imprint title=Imprint alt=Imprint>Imprint</a>
| <a href=https://simonschoof.com/privacy title=Privacy alt=Privacy>Privacy</a>
| <a rel=me href=https://social.simonschoof.com/@connect></a></span></footer></body></html>