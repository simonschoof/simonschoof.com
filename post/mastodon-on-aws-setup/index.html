<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Mastodon on AWS: Running on AWS - Simon Schoof</title>
<meta name=description content="Running Mastodon on AWS using Pulumi"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://simonschoof.com/css/normalize.css><link rel=stylesheet href=https://simonschoof.com/css/barebones.css><link rel=stylesheet href=https://simonschoof.com/css/custom.css><link rel=stylesheet href=https://simonschoof.com/css/prettify.css><link rel=stylesheet href=https://simonschoof.com/css/syntax.css><link rel=stylesheet href=https://simonschoof.com/css/github-prettify-theme.css><link id=prettify-dark rel=stylesheet href=https://simonschoof.com/css/github-prettify-theme-dark.css disabled><link rel=stylesheet href=https://simonschoof.com/css/fontawesome.css><link rel=stylesheet href=https://simonschoof.com/css/googlefonts-raleway.css type=text/css><link rel=alternate type=application/rss+xml href=https://simonschoof.com/post/index.xml title="My Site"><script src=https://simonschoof.com/js/site.js></script><script src=https://simonschoof.com/js/fontawesome.js></script><link rel="shortcut icon" href=https://simonschoof.com/images/favicon.png type=image/png></head><body><nav><label for=drop class=toggle><i class="fas fa-bars u-pull-right" aria-hidden=true></i> <span><i class="fas fa-anchor" aria-hidden=true></i>
Home</span></label>
<input type=checkbox id=drop><ul class=menu><li><a href=https://simonschoof.com/><span><i class="fas fa-anchor" aria-hidden=true></i>
Home</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/post/index.xml class=Members><span><i class='fa-solid fa-rss'></i> rss</span></a></li><li class=u-pull-right><a href=https://social.simonschoof.com/@connect class=Members><span><i class='fab fa-mastodon'></i> mastodon</span></a></li><li class=u-pull-right><a href=https://github.com/simonschoof class=Members><span><i class='fab fa-github'></i> github</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/post class=Members><span><i class='fas fa-list'></i> blog</span></a></li><li class=u-pull-right><a href=https://simonschoof.com/about class=Members><span><i class='fas fa-user'></i> about</span></a></li><li class=u-pull-right><span class=toggle-theme-button-span><button id=toggle-theme-btn-id class=toggle-theme-btn title="Toggle theme" aria-hidden=true onclick=toggleTheme()><div class=toggle-theme-btn-overlay-wrap><span id=dark-theme-span class=dark-theme-span><svg class="toggle-theme-svg" fill="none" viewBox="0 3 48 48" style="overflow:visible"><path fill="#fff" d="M12 11.807c-1.2582-1.2587-2.11512-2.86216-2.46238-4.6077C9.19037 5.45375 9.36832 3.64444 10.049 2c-1.94074.38205-3.7234 1.33431-5.12001 2.735-3.905 3.905-3.905 10.237.0 14.142 3.906 3.906 10.23701 3.905 14.14301.0 1.4003-1.3965 2.3525-3.1787 2.735-5.119C20.1625 14.4385 18.3533 14.6164 16.6077 14.2692 14.8622 13.9219 13.2588 13.0651 12 11.807v0z"/></svg></span>
<span id=light-theme-span class=light-theme-span><svg class="toggle-theme-svg" fill="none" viewBox="0 3 48 48" style="overflow:visible"><path d="M6.995 12c0 2.761 2.246 5.007 5.007 5.007 2.761.0 5.007-2.246 5.007-5.007s-2.246-5.007-5.007-5.007C9.241 6.993 6.995 9.239 6.995 12zM11 19h2v3H11V19zM11 2h2V5H11V2zM2 11H5v2H2V11zm17 0h3v2H19V11z" fill="#fff"/><path d="M5.63702 19.778l-1.414-1.414 2.121-2.121 1.414 1.414-2.121 2.121z" fill="#fff"/><path d="M16.242 6.34405l2.122-2.122 1.414 1.414-2.122 2.122-1.414-1.414z" fill="#fff"/><path d="M6.34402 7.75902l-2.121-2.122 1.415-1.414 2.12 2.122-1.414 1.414z" fill="#fff"/><path d="M19.778 18.3639l-1.414 1.414-2.122-2.122 1.414-1.414 2.122 2.122z" fill="#fff"/></svg></span></div></button></span></li></ul></nav><div class="section hero"><div class=container><h1 class="section-heading section-sized-heading">Mastodon on AWS: Running on AWS</h1><i class="far fa-calendar"></i> 2023-06-01,
<i class="far fa-clock"></i> Reading Time: 31 minutes</h6></div></div><div class="section main"><div class="row content"><article><p>This post is the second part of a series of two articles on deploying and running a <a href=https://docs.joinmastodon.org/ rel="noopener noreferrer">Mastodon</a> instance on <a href=https://aws.amazon.com/ rel="noopener noreferrer">AWS</a>. The code for this part can be found <a href=https://github.com/simonschoof/mastodon-aws/tree/main/infrastructure/aws-services rel="noopener noreferrer">here</a>. In this second part we will cover the steps to run Mastodon on AWS with ECS and Fargate.</p><ul><li hugo-nav=/post/mastodon-on-aws-local-docker/><a href=https://simonschoof.com/post/mastodon-on-aws-local-docker/>Mastodon on AWS: Running locally</a></li><li hugo-nav=/post/mastodon-on-aws-setup/><a href=https://simonschoof.com/post/mastodon-on-aws-setup/>Mastodon on AWS: Running on AWS</a></li></ul><p><em>Update 2023-07-06: As expected, running Mastodon on AWS is way too expensive. Especially for a single user instance. The cost of running the instance on AWS was about $4.82 per day. To reduce costs, I moved the compute (ECS), storage (RDS, Elasticache), and load balancing (ALB) parts of the AWS setup to a hosted solution from <a href=https://weingaertner-it.de/ rel="noopener noreferrer">Weing√§rtner-IT</a>, keeping S3 Bucket, CloudFront, and SES because they cost almost nothing in my scenario. Nonetheless, I had a lot of fun setting it up and getting more insights into creating an AWS infrastructure with Pulumi and F#.</em></p><h3 id=introduction>Introduction</h3><p>Having successfully got Mastodon running locally in the
<a href=https://simonschoof.com/post/mastodon-on-aws-local-docker/>previous part</a>
of this series, we can now set Mastodon up to run on AWS. To set up Mastodon on AWS, we will use <a href=https://www.pulumi.com/ rel="noopener noreferrer">Pulumi</a> with F# to provision the AWS infrastructure and deploy the Mastodon application. Pulumi is my preferred tool for infrastructure as code. I have been using it for a while now as you can see in all of my blog posts in the <a href=https://simonschoof.com/tags/infrastructure-as-code/>infrastructure as code</a> category.</p><p>For the previous part, the goal was to try out Mastodon and get familiar with it so that it would be easier to set up on AWS. To run Mastodon on AWS, I decided to use <a href=https://aws.amazon.com/ecs/ rel="noopener noreferrer">AWS ECS</a> with <a href=https://aws.amazon.com/fargate/ rel="noopener noreferrer">AWS Fargate</a>. As we saw in the previous post and can also read in the <a href=https://docs.joinmastodon.org/user/run-your-own/#so-you-want-to-run-your-own-mastodon-server rel="noopener noreferrer">Run your own server</a> section of the Mastodon documentation, we need more than just the compute part of AWS to get Mastodon running. In the table below, I have listed the required parts from the <em>Run your own server</em> documentation again and noted next to them the providers we will use to provide the functionality. Later we will go into more detail about what we need to do for each part of the AWS infrastructure.</p><div align=center><div style=width:95%><div class=table-wrapper><table style=width:95%><thead><tr></tr></thead><tbody><table style=table-layout:fixed;width:100%><thead><tr><th style=text-align:left>Component</th><th style=text-align:left>Solution</th></tr></thead><tbody><tr><td style=word-wrap:break-word style=text-align:left>A domain name</td><td style=word-wrap:break-word style=text-align:left><a href=https://social.simonschoof.com rel="noopener noreferrer">social.simonschoof.com</a>: Not hosted on AWS, just a subdomain on my existing domain registrar.</td></tr><tr><td style=word-wrap:break-word style=text-align:left>A VPS</td><td style=word-wrap:break-word style=text-align:left>We will use ECS and Fargate to run Mastodon, Aurora Serverless V2 for the database and Elasticache for Redis.</td></tr><tr><td style=word-wrap:break-word style=text-align:left>An email provider.</td><td style=word-wrap:break-word style=text-align:left>We will use AWS SES.</td></tr><tr><td style=word-wrap:break-word style=text-align:left>Optional: Object storage provider</td><td style=word-wrap:break-word style=text-align:left>We will use AWS S3 and CloudFront for the files uploaded by the users.</td></tr></tbody></table></tbody></table></div></div></div><p>In the following sections I will give a brief overview of the architecture and the different parts of the AWS infrastructure. We will then go into more detail on how the different parts are set up.</p><h3 id=architecture>Architecture</h3><p>The general architecture in AWS to run Mastodon looks like this:</p><figure2 class=mastodon-aws-architecture><img src=https://simonschoof.com/images/aws_architecture.drawio.svg alt="AWS Architecture for Mastodon"><figcaption><p>AWS Architecture for Mastodon</p></figcaption></figure2><p>The general idea was to make the architecture as &ldquo;simple&rdquo; as possible.
This means that we will use the default <a href=https://aws.amazon.com/vpc/ rel="noopener noreferrer">VPC</a>, which is public by default, and the default <a href=https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html rel="noopener noreferrer">subnets</a> provided by AWS. For a more critical application, for example, I would put the database, ECS service and other components on a private subnet as <a href=https://docs.aws.amazon.com/vpc/latest/userguide/infrastructure-security.html rel="noopener noreferrer">recommended by AWS</a>. Without a private subnet, we can secure the services using <a href=https://docs.aws.amazon.com/vpc/latest/userguide/security-groups.html rel="noopener noreferrer">security groups</a>, which we will do.</p><p>As shown in the architecture diagram, we will use the following AWS services:</p><ul><li><a href=https://aws.amazon.com/vpc/ rel="noopener noreferrer">AWS VPC</a> for the VPC</li><li><a href="https://aws.amazon.com/elasticloadbalancing/application-load-balancer/?nc=sn&amp;loc=2&amp;dn=2" rel="noopener noreferrer">AWS Application Load Balancer(ALB)</a> for the load balancer</li><li><a href=https://aws.amazon.com/rds/aurora/serverless/ rel="noopener noreferrer">AWS Aurora Serverless V2</a> with a <a href=https://www.postgresql.org/ rel="noopener noreferrer">PostgreSQL</a> engine for the database</li><li><a href=https://aws.amazon.com/elasticache/redis/ rel="noopener noreferrer">AWS Elasticache for Redis</a> for <a href=https://redis.io/ rel="noopener noreferrer">Redis</a></li><li><a href=https://aws.amazon.com/ecs/ rel="noopener noreferrer">AWS ECS</a> and <a href=https://aws.amazon.com/fargate/ rel="noopener noreferrer">AWS Fargate</a> for the container orchestration</li><li><a href=https://aws.amazon.com/ses/ rel="noopener noreferrer">AWS SES</a> for the e-mail provider</li><li><a href=https://aws.amazon.com/s3/ rel="noopener noreferrer">AWS S3</a> for the object storage provider</li><li><a href=https://aws.amazon.com/cloudfront/ rel="noopener noreferrer">AWS CloudFront</a> for the CDN</li><li><a href=https://aws.amazon.com/systems-manager/features/#Parameter_Store rel="noopener noreferrer">AWS Systems Manager Parameter Store</a> for configuration</li><li><a href=https://aws.amazon.com/secrets-manager/ rel="noopener noreferrer">AWS Secrets Manager</a> for secrets</li><li><a href=https://aws.amazon.com/certificate-manager/ rel="noopener noreferrer">AWS Certificate Manager</a> for certificates</li></ul><p>As mentioned earlier, we will use the standard VPC and subnets provided by AWS. Within the VPC, we will provide an ALB to direct traffic to the <a href=https://docs.joinmastodon.org/dev/overview/ rel="noopener noreferrer">web container</a>, running a <a href=https://rubyonrails.org/ rel="noopener noreferrer">Ruby on Rails</a> backend with a <a href=https://reactjs.org/ rel="noopener noreferrer">React.js</a> frontend, and to the <a href=https://docs.joinmastodon.org/methods/streaming/ rel="noopener noreferrer">streaming container</a>, a <a href=https://nodejs.org/en/ rel="noopener noreferrer">Node.js</a> application for the streaming API. Since the web container and the streaming container are accessed via different ports and paths, we will use two target groups for the ALB. One for the web container listening on port 3000 and the other for the streaming container listening on port 4000 and accessed via the path <code>/api/v1/streaming</code>. The tasks within the ECS service will be able to access the PostgreSQL and Redis databases, the S3 bucket and the SES service.</p><p>The ALB is secured by a security group that only allows traffic from the Internet via port 80 and 443. The http traffic on port 80 is redirected to https on port 443. The https traffic is secured by a certificate from AWS Certificate Manager. The certificate is requested for the domain name <code>social.simonschoof.com</code> of the Mastodon instance. The web and streaming containers running on ECS and Fargate are secured by a security group that only allows traffic from the ALB and to PostgreSQL, Redis, S3 and SES. The PostgreSQL and Redis databases are also protected by a security group that only allows traffic from the web and streaming containers running on ECS and Fargate.</p><p>In order for the Mastodon instance to send emails, we use AWS SES.
AWS SES is configured to use the domain name of the Mastodon instance as the sender domain. The sender domain must be verified in AWS SES. In addition, AWS SES is configured to use the SMTP interface to send emails. The SMTP credentials are stored in AWS Secrets Manager.</p><p>AWS S3 will be used to store the user uploaded media files. As I wanted to keep the bucket private, we will use a CloudFront distribution to serve the media files to the users. AWS CloudFront will be configured to use the subdomain <code>mastodonmedia.simonschoof.com</code> and only allow https traffic. The certificate for the subdomain is requested from the AWS Certificate Manager.</p><p>The configuration for the Mastodon instance is stored in the AWS Systems Manager Parameter Store. The secrets are stored in AWS Secrets Manager. The parameters and secrets are retrieved via Pulumi during the deployment of the Mastodon instance and set as environment variables in the ECS task definition.</p><p>After the general overview of the architecture, we will now go into more detail on how the different parts of the AWS infrastructure are set up.</p><h3 id=domain-name-and-certificates>Domain name and certificates</h3><p>As mentioned above, we will use the AWS Certificate Manager to request the certificates for the instance domain name <code>social.simonschoof.com</code> and the media file domain name <code>mastodonmedia.simonschoof.com</code>. Since I have already registered a domain name with a domain registrar, I will not use <a href=https://aws.amazon.com/route53/%5c rel="noopener noreferrer">AWS Route 53</a> to register the domain name. Instead, I will use the DNS validation method to validate the domain names. For this purpose, I created a CNAME record in my domain registrar&rsquo;s DNS configuration that points to the DNS name provided by the AWS Certificate Manager. For the media file domain used as the alternate domain name for the CloudFront distribution, the certificate is requested in the region <code>us-east-1</code>, which is a <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/CNAMEs.html rel="noopener noreferrer">requirement for CloudFront</a>. For the instance&rsquo;s domain name, the certificate is requested in the region <code>eu-central-1</code>, which is the region I use for all other resources. All the steps to request the certificates and the DNS validation were done manually by me in the AWS console and at my domain registrar and are not part of the Pulumi code.</p><h3 id=ses>SES</h3><p>Another part of the application where I did not use Pulumi was setting up the AWS SES service. Setting up AWS SES is quite simple and is described in the <a href=https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-email-set-up.html rel="noopener noreferrer">AWS SES documentation</a>. The SMTP credentials can be created manually in the AWS SES console. The SMTP credentials are stored in the AWS Secrets Manager, from where they are retrieved during the deployment of the Mastodon instance, as we will see later in the <a href=#configuration-and-secrets>configuration-and-secrets</a> section. The SES credentials to be created are unique per region. When you start with AWS SES, you are in the sandbox mode. In the sandbox mode, you can only send emails to verified email addresses. To send email to non-verified email addresses, you must request production access. This is also described in the <a href=https://docs.aws.amazon.com/ses/latest/DeveloperGuide/request-production-access.html rel="noopener noreferrer">AWS SES documentation</a>. For setting up a single user instance configuration, it is not necessary to request production access because the only email the instance will write to is the email of my admin user account. So I only checked the email address of my admin user account and did not request production access.</p><h3 id=vpc-and-security-groups>VPC and security groups</h3><p>To run Mastodon in AWS, we need a network infrastructure to run the various services. As mentioned earlier, we will use the default VPC and subnets provided by AWS. To secure the services within the VPC, we will use security groups for the different services. For a Mastodon instance with one user, this setup seems to be sufficient. For an instance with multiple users, you should use a private subnet for the database and Redis, as recommended by AWS. The VPC and security groups are created via Pulumi. The default VPC and subnets should be in place and automatically created by AWS when you create an AWS account.</p><p>If you define the <a href=https://www.pulumi.com/registry/packages/aws/api-docs/ec2/defaultvpc/ rel="noopener noreferrer">default VPC</a> and <a href=https://www.pulumi.com/registry/packages/aws/api-docs/ec2/defaultsubnet/ rel="noopener noreferrer">default subnets</a> in Pulumi, both will be added to the Pulumi stack but will not be managed by Pulumi. This means that removing the default VPC and subnets from the Pulumi stack does not remove them from AWS unless explicitly specified. To add the default VPC and subnets to the Pulumi stack, we just need to write the following code<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>defaultVpc</span> <span class=o>=</span> <span class=n>DefaultVpc</span><span class=o>(</span><span class=s>&#34;default-vpc&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>defaultSubnets</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>subnetInvokeArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>GetSubnetsInvokeArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Filters</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=o>(</span>
</span></span><span class=line><span class=cl>                                <span class=n>GetSubnetsFilterInputArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;vpc-id&#34;</span><span class=o>,</span> <span class=n>Values</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>defaultVpc</span><span class=o>.</span><span class=n>Id</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>                            <span class=o>)</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nn>GetSubnets</span><span class=p>.</span><span class=n>Invoke</span><span class=o>(</span><span class=n>subnetInvokeArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>defaultSubnetIds</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=nn>List</span><span class=p>.</span><span class=n>init</span> <span class=n>3</span> <span class=o>(</span><span class=k>fun</span> <span class=n>n</span> <span class=o>-&gt;</span> <span class=n>defaultSubnets</span><span class=o>.</span><span class=n>Apply</span><span class=o>(</span><span class=k>fun</span> <span class=n>subnets</span> <span class=o>-&gt;</span> <span class=n>subnets</span><span class=o>.</span><span class=n>Ids</span><span class=o>.[</span><span class=n>n</span><span class=o>]))</span>
</span></span></code></pre></div><p>Then we can define the security groups for the different services. There will be a security group for:</p><ul><li>the PostgreSQL database<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li><li>the Redis database</li><li>the ECS Fargate service</li><li>the ALB</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>rdsSecurityGroup</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>rdsSecurityGroupArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupArgs</span><span class=o>(</span><span class=n>Description</span> <span class=o>=</span> <span class=s>&#34;Allow inbound traffic from ECS to RDS&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroup</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;rds-security-group&#34;</span><span class=o>,</span> <span class=n>rdsSecurityGroupArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>elasticacheSecurityGroup</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>elasticacheSecurityGroupArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupArgs</span><span class=o>(</span><span class=n>Description</span> <span class=o>=</span> <span class=s>&#34;Allow inbound traffic from ECS to Elasticache&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroup</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;elasticache-security-group&#34;</span><span class=o>,</span> <span class=n>elasticacheSecurityGroupArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroup</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>ecsSecurityGroupArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupArgs</span><span class=o>(</span><span class=n>Description</span> <span class=o>=</span> <span class=s>&#34;Ecs Security Group&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroup</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;ecs-security-group&#34;</span><span class=o>,</span> <span class=n>ecsSecurityGroupArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>loadBalancerSecurityGroup</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>loadBalancerSecurityGroupArgs</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupArgs</span><span class=o>(</span><span class=n>Description</span> <span class=o>=</span> <span class=s>&#34;Loadbalancer Security Group&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroup</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;loadbalancer-security-group&#34;</span><span class=o>,</span> <span class=n>loadBalancerSecurityGroupArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>After we have defined the security groups, we can add rules to these groups. We can add rules for incoming and outgoing traffic. First we define the rules for incoming traffic as follows:</p><ul><li>The RDS security group allows incoming traffic from the ECS security group on port 5432.</li><li>The Elasticache security group allows incoming traffic from the ECS security group on port 6379.</li><li>The ECS security group allows inbound traffic from the load balancer security group on port 3000 and 4000 for the Mastodon web and streaming service.</li><li>The load balancer security group allows incoming traffic from the Internet on port 80 and 443 for the Mastodon web service. The incoming traffic on port 80 is redirected to port 443, as we will see later in the <a href=#alb>Load Balancer section</a>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>rdsSecurityGroupInboundRule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>rdsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;ingress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>5432</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>5432</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>SourceSecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;rds-inbound-tcp-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>elastiCacheSecurityGroupInboundRule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>elasticacheSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;ingress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>6379</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>6379</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>SourceSecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;elasticache-inbound-tcp-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroupIp4MastodonWebTrafficInboundRule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;ingress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>3000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>3000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>SourceSecurityGroupId</span> <span class=o>=</span> <span class=n>loadBalancerSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;ecs-inbound-mastodon-web-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroupIp4MastodonStreamingTrafficInboundRule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;ingress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>4000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>4000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>SourceSecurityGroupId</span> <span class=o>=</span> <span class=n>loadBalancerSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;ecs-inbound-mastodon-streaming-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>loadBalancerSecurityGroupIp4HttpTrafficInboundRule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>loadBalancerSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;ingress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>80</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>80</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span><span class=o>]</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;loadbalancer-inbound-http-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>loadBalancerSecurityGroupIp4HttpsTrafficInboundRule</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>loadBalancerSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;ingress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>443</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>443</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span><span class=o>]</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;loadbalancer-inbound-https-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>After we have defined the rules for incoming traffic, we can define the rules for outgoing traffic as follows:</p><ul><li>The load balancer security group allows outbound traffic to port 3000 and 4000 for the Mastodon web and streaming service running on the ECS service.</li><li>The ECS security group allows outbound traffic to the RDS security group on port 5432 for the PostgreSQL database.</li><li>The ECS security group allows outbound traffic to the Elasticache security group on port 6379 for the Redis database.</li><li>The ECS security group allows outbound traffic to the internet on port 80 and 443 for the Mastodon web and streaming service.</li><li>The ECS security group allows outbound traffic to SES on port 587 for sending emails.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>loadBalancerSecurityGroupIp4WebTcpOutboundRule</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>loadBalancerSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;egress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>3000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>3000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;loadbalancer-outbound-all-web-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>loadBalancerSecurityGroupIp4StreamingTcpOutboundRule</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>loadBalancerSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;egress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>4000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>4000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;loadbalancer-outbound-all-streaming-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroupIp4RdsTcpOutboundRule</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;egress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>5432</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>5432</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span><span class=s>&#34;ecs-outbound-rds-tcp-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroupIp4RedisTcpOutboundRule</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;egress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>6379</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>6379</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span><span class=s>&#34;ecs-outbound-redis-tcp-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroupIp4SmtpTcpOutboundRule</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;egress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>int</span> <span class=n>smtpPort</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>int</span> <span class=n>smtpPort</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span><span class=s>&#34;ecs-outbound-smtp-tcp-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroupIp4HttpTcpOutboundRule</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;egress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>80</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>80</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span><span class=s>&#34;ecs-outbound-http-tcp-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>ecsSecurityGroupIp4HttpsTcpOutboundRule</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>securityGroupRuleArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>SecurityGroupId</span> <span class=o>=</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;egress&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FromPort</span> <span class=o>=</span> <span class=n>443</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ToPort</span> <span class=o>=</span> <span class=n>443</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;tcp&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CidrBlocks</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;0.0.0.0/0&#34;</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroupRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span><span class=s>&#34;ecs-outbound-https-tcp-ip4-security-group-rule&#34;</span><span class=o>,</span> <span class=n>securityGroupRuleArgs</span><span class=o>)</span>
</span></span></code></pre></div><h3 id=postgresql-and-redis>PostgreSQL and Redis</h3><p>After defining the VPC, the subnets, the security groups, and the security group rules, we can start to add the resources that will be deployed in the VPC. The first resources that we will add are the PostgreSQL and Redis databases.</p><h5 id=postgresql>PostgreSQL</h5><p>For the PostgreSQL database I decided to try the AWS Aurora serverless v2 version which is, according to AWS, <a href=https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-serverless-v2.html rel="noopener noreferrer">a good fit for development and testing environments</a> because we can define a low minimum capacity for the database. Defining the PostgreSQL database is straigthforward and it is defined as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>clusterServerlessv2ScalingConfigurationArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>ClusterServerlessv2ScalingConfigurationArgs</span><span class=o>(</span><span class=n>MaxCapacity</span> <span class=o>=</span> <span class=n>1</span><span class=o>.</span><span class=n>0</span><span class=o>,</span> <span class=n>MinCapacity</span> <span class=o>=</span> <span class=n>0</span><span class=o>.</span><span class=n>5</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>cluster</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>clusterArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>ClusterArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ClusterIdentifier</span> <span class=o>=</span> <span class=n>prefixMastodonResource</span> <span class=s>&#34;rds-cluster-identifier&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Engine</span> <span class=o>=</span> <span class=s>&#34;aurora-postgresql&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>EngineMode</span> <span class=o>=</span> <span class=s>&#34;provisioned&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>EngineVersion</span> <span class=o>=</span> <span class=s>&#34;14.5&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>DatabaseName</span> <span class=o>=</span> <span class=s>&#34;mastodon&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>MasterUsername</span> <span class=o>=</span> <span class=s>&#34;postgres&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>MasterPassword</span> <span class=o>=</span> <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=n>rdsDbMasterPassword</span><span class=o>),</span>
</span></span><span class=line><span class=cl>            <span class=n>SkipFinalSnapshot</span> <span class=o>=</span> <span class=k>false</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>FinalSnapshotIdentifier</span> <span class=o>=</span> <span class=s>&#34;mastodon-rds-final-snapshot&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ApplyImmediately</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>DeletionProtection</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Serverlessv2ScalingConfiguration</span> <span class=o>=</span> <span class=n>clusterServerlessv2ScalingConfigurationArgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>VpcSecurityGroupIds</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>rdsSecurityGroup</span><span class=o>.</span><span class=n>Id</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Cluster</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;rds-cluster&#34;</span><span class=o>,</span> <span class=n>clusterArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>clusterInstanceArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>ClusterInstanceArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>ClusterIdentifier</span> <span class=o>=</span> <span class=n>cluster</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>InstanceClass</span> <span class=o>=</span> <span class=s>&#34;db.serverless&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Engine</span> <span class=o>=</span> <span class=n>cluster</span><span class=o>.</span><span class=n>Engine</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>EngineVersion</span> <span class=o>=</span> <span class=n>cluster</span><span class=o>.</span><span class=n>EngineVersion</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ClusterInstance</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;rds-cluster-instance&#34;</span><span class=o>,</span> <span class=n>clusterInstanceArgs</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
</span></span></code></pre></div><p>To use the Aurora serverless v2 version we need to define the <code>EngineMode</code> as <code>provisioned</code> and provide the <code>Serverlessv2ScalingConfiguration</code> argument. I also set the deletion protection to <code>true</code> to prevent the database from being deleted by accident. Furthermore, I set the <code>SkipFinalSnapshot</code> argument to <code>false</code> and provide a <code>FinalSnapshotIdentifier</code> to create a final snapshot of the database when it is deleted. The last thing to point out is that I set the <code>ApplyImmediately</code> argument to <code>true</code> to apply changes immediately and not wait for the next maintenance window.</p><h5 id=redis>Redis</h5><p>The Redis database is even easier to define than the PostgreSQL database. The Redis database is defined as follows where I chose the smallest instance type <code>cache.t3.micro</code> and the latest Redis version <code>7.0</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>createElastiCacheCluster</span> <span class=bp>()</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>clusterArgs</span> <span class=o>=</span> <span class=n>ClusterArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Engine</span> <span class=o>=</span> <span class=s>&#34;redis&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>EngineVersion</span> <span class=o>=</span> <span class=s>&#34;7.0&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>NodeType</span> <span class=o>=</span> <span class=s>&#34;cache.t3.micro&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>NumCacheNodes</span> <span class=o>=</span> <span class=n>1</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ParameterGroupName</span> <span class=o>=</span> <span class=s>&#34;default.redis7&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Port</span> <span class=o>=</span> <span class=n>6379</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ApplyImmediately</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroupIds</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>elasticacheSecurityGroup</span><span class=o>.</span><span class=n>Id</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Cluster</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;elasticache-cluster&#34;</span><span class=o>,</span> <span class=n>clusterArgs</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
</span></span><span class=line><span class=cl>    <span class=bp>()</span>
</span></span></code></pre></div><p>As in the case of the PostgreSQL database, I set the <code>ApplyImmediately</code> argument to <code>true</code> to apply changes immediately and not wait for the next maintenance window.</p><h3 id=alb-container-task-definitions-and-ecs-with-fargate>ALB, container task definitions and ECS with Fargate</h3><p>The next step is to define the Application Load Balancer (ALB), the Elastic Container Service (ECS) and the Fargate tasks. This is, next to the S3 bucket and the CloudFront distribution, the most complex part of the deployment. We will go through the different parts step by step, starting with the ALB. For the Pulumi code in this section, we use both the <a href=https://www.pulumi.com/registry/packages/aws/ rel="noopener noreferrer">classic AWS package</a> <code>Pulumi.Aws</code> and the <a href=https://www.pulumi.com/docs/clouds/aws/guides/ rel="noopener noreferrer">AWS crosswalk package</a> <code>Pulumi.Awsx</code>. When using the crosswalk package, we use the qualified name <code>Awsx</code> to avoid name conflicts with the classic AWS package.</p><h5 id=alb>ALB</h5><p>Before we can start defining the ALB, we need to obtain the certificate for the Mastodon instance domain:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>cert</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>getCertificateInvokeArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>GetCertificateInvokeArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Domain</span> <span class=o>=</span> <span class=n>localDomain</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>MostRecent</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Types</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;AMAZON_ISSUED&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nn>GetCertificate</span><span class=p>.</span><span class=n>Invoke</span><span class=o>(</span><span class=n>getCertificateInvokeArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>With the certificate in hand, we can start defining the ALB itself:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>loadBalancerArgs</span> <span class=o>=</span> <span class=n>LoadBalancerArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>IpAddressType</span> <span class=o>=</span> <span class=s>&#34;ipv4&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LoadBalancerType</span> <span class=o>=</span> <span class=s>&#34;application&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>SecurityGroups</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>loadBalancerSecurityGroup</span><span class=o>.</span><span class=n>Id</span><span class=o>],</span>
</span></span><span class=line><span class=cl>    <span class=n>Subnets</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>(</span><span class=n>defaultSubnetIds</span> <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=n>io</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>loadBalancer</span> <span class=o>=</span> <span class=n>LoadBalancer</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;load-balancer&#34;</span><span class=o>,</span> <span class=n>loadBalancerArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>In addition to the load balancer itself, we define two <a href=https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html rel="noopener noreferrer">target groups</a>. Target groups are used to forward requests to the different services running in the ECS cluster. In our case, we define a target group for the Mastodon web application listening on port <code>3000</code> and a target group for the Mastodon streaming application listening on port <code>4000</code> and the path <code>/api/v1/streaming/health</code>. The target groups are defined as follows</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>webTargetGroupArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>TargetGroupArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>TargetType</span> <span class=o>=</span> <span class=s>&#34;ip&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Port</span> <span class=o>=</span> <span class=n>3000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;HTTP&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>VpcId</span> <span class=o>=</span> <span class=n>defaultVpc</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>HealthCheck</span> <span class=o>=</span> <span class=n>TargetGroupHealthCheckArgs</span><span class=o>(</span><span class=n>Interval</span> <span class=o>=</span> <span class=n>30</span><span class=o>,</span> <span class=n>Path</span> <span class=o>=</span> <span class=s>&#34;/health&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>webTargetGroup</span> <span class=o>=</span> <span class=n>TargetGroup</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;web-tg&#34;</span><span class=o>,</span> <span class=n>webTargetGroupArgs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>streamingTargetGroupArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>TargetGroupArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>TargetType</span> <span class=o>=</span> <span class=s>&#34;ip&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Port</span> <span class=o>=</span> <span class=n>4000</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;HTTP&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>VpcId</span> <span class=o>=</span> <span class=n>defaultVpc</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>HealthCheck</span> <span class=o>=</span> <span class=n>TargetGroupHealthCheckArgs</span><span class=o>(</span><span class=n>Interval</span> <span class=o>=</span> <span class=n>30</span><span class=o>,</span> <span class=n>Path</span> <span class=o>=</span> <span class=s>&#34;/api/v1/streaming/health&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>streamingTargetGroup</span> <span class=o>=</span> <span class=n>TargetGroup</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;streaming-tg&#34;</span><span class=o>,</span> <span class=n>streamingTargetGroupArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>As mentioned earlier, the http requests on port 80 are redirected to port 443. To map this in AWS with Pulumi, we define an http listener as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>httpDefaultAction</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>ListenerDefaultActionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;redirect&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Redirect</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>ListenerDefaultActionRedirectArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>Port</span> <span class=o>=</span> <span class=s>&#34;443&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;HTTPS&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>StatusCode</span> <span class=o>=</span> <span class=s>&#34;HTTP_301&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>httpListenerArgs</span> <span class=o>=</span> <span class=n>ListenerArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>LoadBalancerArn</span> <span class=o>=</span> <span class=n>loadBalancer</span><span class=o>.</span><span class=n>Arn</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Port</span> <span class=o>=</span> <span class=n>80</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;HTTP&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>DefaultActions</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=n>httpDefaultAction</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Listener</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;http-listener&#34;</span><span class=o>,</span> <span class=n>httpListenerArgs</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
</span></span></code></pre></div><p>In the listener args we connect the listener to the load balancer and define the default action to redirect the requests to port 443. To handle the https requests, we define an https listener connected to the load balancer and the certificate we obtained at the beginning of this section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>httpsDefaultAction</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>ListenerDefaultActionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;forward&#34;</span><span class=o>,</span>                
</span></span><span class=line><span class=cl>        <span class=n>TargetGroupArn</span> <span class=o>=</span> <span class=n>webTargetGroup</span><span class=o>.</span><span class=n>Arn</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>httpsListenerArgs</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=n>ListenerArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>LoadBalancerArn</span> <span class=o>=</span> <span class=n>loadBalancer</span><span class=o>.</span><span class=n>Arn</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Port</span> <span class=o>=</span> <span class=n>443</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Protocol</span> <span class=o>=</span> <span class=s>&#34;HTTPS&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>SslPolicy</span> <span class=o>=</span> <span class=s>&#34;ELBSecurityPolicy-2016-08&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>CertificateArn</span> <span class=o>=</span> <span class=n>io</span> <span class=o>(</span><span class=n>cert</span><span class=o>.</span><span class=n>Apply</span><span class=o>(</span><span class=k>fun</span> <span class=n>cert</span> <span class=o>-&gt;</span> <span class=n>cert</span><span class=o>.</span><span class=n>Arn</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>        <span class=n>DefaultActions</span> <span class=o>=</span>  <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=n>httpsDefaultAction</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>httpsListener</span> <span class=o>=</span> <span class=n>Listener</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;https-listener&#34;</span><span class=o>,</span> <span class=n>httpsListenerArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>The streaming application is accessible via port 4000 and the path <code>/api/v1/streaming</code>. To get the correct routing, we need to define a rule for the streaming target group:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>listRuleConditionPathPatternArgs</span> <span class=o>=</span> <span class=n>ListenerRuleConditionPathPatternArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Values</span> <span class=o>=</span> <span class=n>inputList</span>  <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;/api/v1/streaming&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>listenerRuleConditionArgs</span> <span class=o>=</span> <span class=n>ListenerRuleConditionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>PathPattern</span> <span class=o>=</span> <span class=n>listRuleConditionPathPatternArgs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>listenerRuleActionArgs</span> <span class=o>=</span> <span class=n>ListenerRuleActionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;forward&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>TargetGroupArn</span> <span class=o>=</span> <span class=n>streamingTargetGroup</span><span class=o>.</span><span class=n>Arn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>listenerRuleArgs</span> <span class=o>=</span> <span class=n>ListenerRuleArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>ListenerArn</span> <span class=o>=</span> <span class=n>httpsListener</span><span class=o>.</span><span class=n>Arn</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Priority</span> <span class=o>=</span> <span class=n>1</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Conditions</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span><span class=n>input</span> <span class=n>listenerRuleConditionArgs</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>    <span class=n>Actions</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span><span class=n>input</span> <span class=n>listenerRuleActionArgs</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ListenerRule</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;streaming-api-path-rule&#34;</span><span class=o>,</span><span class=n>listenerRuleArgs</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
</span></span></code></pre></div><h5 id=container-task-definitions>Container task definitions</h5><p>Once the ALB is set up, we can start defining the <a href=https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html rel="noopener noreferrer">ESC task</a> and the <a href=https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_ContainerDefinition.html rel="noopener noreferrer">container definitions</a> that will be launched as part of the task. In our case, we define a task with four containers, one for the Mastodon web application, one for the Mastodon streaming application, one for the Mastodon Sidekiq application, and an optional container definition for a PostgreSQL container for maintenance and debugging purposes<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><p>All container definitions are stored in a list that is later made available to the Fargate service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>containerDefinitionsList</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>System</span><span class=p>.</span><span class=nn>Collections</span><span class=p>.</span><span class=nn>Generic</span><span class=p>.</span><span class=n>Dictionary</span><span class=o>&lt;</span><span class=kt>string</span><span class=o>,</span> <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>TaskDefinitionContainerDefinitionArgs</span><span class=o>&gt;</span><span class=bp>()</span>
</span></span></code></pre></div><p>We start with the PostgreSQL container definition. The PostgreSQL container definition is optional and can be used for maintenance and debugging purposes. The PostgreSQL task definition is started only when the <code>RunMode</code> is set to <code>Debug</code> or <code>Maintenance</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>postgresContainer</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>runMode</span> <span class=k>with</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>Maintenance</span> <span class=o>|</span> <span class=n>Debug</span> <span class=o>-&gt;</span> 
</span></span><span class=line><span class=cl>            <span class=k>let</span> <span class=nv>taskDefinitionContainerDefinitionArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>TaskDefinitionContainerDefinitionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>Image</span> <span class=o>=</span> <span class=s>&#34;postgres:latest&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>Command</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                            <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;bash&#34;</span>
</span></span><span class=line><span class=cl>                                        <span class=n>input</span> <span class=s>&#34;-c&#34;</span>
</span></span><span class=line><span class=cl>                                        <span class=n>input</span> <span class=s>&#34;while true; do sleep 3600; done&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>Essential</span> <span class=o>=</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>            <span class=n>containerDefinitionsList</span><span class=o>.</span><span class=n>Add</span><span class=o>(</span><span class=s>&#34;psql&#34;</span><span class=o>,</span> <span class=n>taskDefinitionContainerDefinitionArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>()</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>Production</span> <span class=o>-&gt;</span> <span class=bp>()</span>
</span></span></code></pre></div><p>The PostgreSQL container is based on the <code>postgres:latest</code> image and runs a bash script that sleeps for 3600 seconds. This is done to keep the container running. The PostgreSQL container is not essential and will not be restarted if it fails. This is done to prevent the PostgreSQL container from restarting when the database is unavailable.</p><p>Next, we define the Mastodon web application container. For the web application, we define a container port mapping for port 3000, where we map the port to the web target group defined earlier. We also define a container command that starts the Mastodon web application. The container command is different depending on the <code>runMode</code>. For <code>Maintenance</code> and <code>Debug</code>, we start a bash script that sleeps for 3600 seconds so we can connect to the container and debug the application. For <code>Production</code> we start the Mastodon web application. The container is configured using environment variables that are required for Mastodon. How these environment variables are defined is explained in the section <a href=#configuration-and-secrets>Configuration and secrets</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>webContainerportMappingArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>TaskDefinitionPortMappingArgs</span><span class=o>(</span><span class=n>ContainerPort</span> <span class=o>=</span> <span class=n>3000</span><span class=o>,</span> <span class=n>TargetGroup</span> <span class=o>=</span> <span class=n>webTargetGroup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>webContainerCommand</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>runMode</span> <span class=k>with</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>Maintenance</span> <span class=o>|</span> <span class=n>Debug</span> <span class=o>-&gt;</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;bash&#34;</span><span class=o>;</span> <span class=n>input</span> <span class=s>&#34;-c&#34;</span><span class=o>;</span> <span class=n>input</span> <span class=s>&#34;while true; do sleep 3600; done&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>Production</span> <span class=o>-&gt;</span>  <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;bash&#34;</span><span class=o>;</span> <span class=n>input</span> <span class=s>&#34;-c&#34;</span><span class=o>;</span> <span class=n>input</span> <span class=s>&#34;rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>webContainer</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>TaskDefinitionContainerDefinitionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Image</span> <span class=o>=</span> <span class=n>mastodonImage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Command</span> <span class=o>=</span> <span class=n>webContainerCommand</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Cpu</span> <span class=o>=</span> <span class=n>256</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Memory</span> <span class=o>=</span> <span class=n>512</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Essential</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Environment</span> <span class=o>=</span> <span class=n>mastodonContainerEnvVariables</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>PortMappings</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=n>webContainerportMappingArgs</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>containerDefinitionsList</span><span class=o>.</span><span class=n>Add</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;web&#34;</span><span class=o>,</span> <span class=n>webContainer</span><span class=o>)</span>
</span></span></code></pre></div><p>In analogy to the web application container, we define the Mastodon Streaming Application Container. Again, we define a port mapping that maps port 4000 to the streaming target. The container command launches the Mastodon streaming application as a Node.js application. The container is also configured with the environment variables that are required for Mastodon:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>streamingContainerportMappingArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>TaskDefinitionPortMappingArgs</span><span class=o>(</span><span class=n>ContainerPort</span> <span class=o>=</span> <span class=n>4000</span><span class=o>,</span> <span class=n>TargetGroup</span> <span class=o>=</span> <span class=n>streamingTargetGroup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>streamingContainer</span> <span class=o>=</span> <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>TaskDefinitionContainerDefinitionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Image</span> <span class=o>=</span> <span class=n>mastodonImage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Command</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;bash&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>input</span> <span class=s>&#34;-c&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>input</span> <span class=s>&#34;node ./streaming&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>    <span class=n>Cpu</span> <span class=o>=</span> <span class=n>256</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span> <span class=o>=</span> <span class=n>256</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Essential</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Environment</span> <span class=o>=</span> <span class=n>mastodonContainerEnvVariables</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PortMappings</span> <span class=o>=</span> <span class=n>inputList</span><span class=o>[</span> <span class=n>input</span> <span class=n>streamingContainerportMappingArgs</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>containerDefinitionsList</span><span class=o>.</span><span class=n>Add</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;streaming&#34;</span><span class=o>,</span><span class=n>streamingContainer</span><span class=o>)</span>
</span></span></code></pre></div><p>The last container we define is the Mastodon <a href=https://sidekiq.org/ rel="noopener noreferrer">Sidekiq</a> container. The Sidekiq framework is used for background job processing in combination with Ruby on Rails applications. The Sidekiq application is also configured with the environment variables that are required for Mastodon. For the Sidekiq container we don&rsquo;t define a port mapping as the Sidekiq container is not reachable from the outside and only communicates with the Mastodon web application over the internal network of the Fargate service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>sidekiqContainer</span> <span class=o>=</span> <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>TaskDefinitionContainerDefinitionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Image</span> <span class=o>=</span> <span class=n>mastodonImage</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Command</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;bash&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>input</span> <span class=s>&#34;-c&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>input</span> <span class=s>&#34;bundle exec sidekiq&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>    <span class=n>Cpu</span> <span class=o>=</span> <span class=n>256</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span> <span class=o>=</span> <span class=n>256</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Environment</span> <span class=o>=</span> <span class=n>mastodonContainerEnvVariables</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Essential</span> <span class=o>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>containerDefinitionsList</span><span class=o>.</span><span class=n>Add</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;sidekiq&#34;</span><span class=o>,</span><span class=n>sidekiqContainer</span><span class=o>)</span>
</span></span></code></pre></div><h5 id=ecs-with-fargate>ECS with Fargate</h5><p>After completing the container task definition, we can start defining the ECS cluster using Fargate as the compute engine.</p><p>First we define the ECS cluster to logically group the containers running in the ECS cluster. Here we also set the capacity provider to <code>FARGATE_SPOT</code>, hoping that this will save us some money<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>clusterArgs</span> <span class=o>=</span> <span class=n>ClusterArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>CapacityProviders</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span><span class=n>input</span> <span class=s>&#34;FARGATE_SPOT&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>cluster</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>Cluster</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;ecs-cluster&#34;</span><span class=o>,</span> <span class=n>clusterArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>In the second step, we prepare a task role that allows us to connect to the containers in the ECS cluster. For this, we need an assume role policy and a task policy that enables communication between the containers and the managed SSM agent. This is required to connect to the containers via AWS ECS Exec. The task role is defined as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>assumeRolePolicy</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=s>@&#34;{
</span></span></span><span class=line><span class=cl><span class=s>    &#34;&#34;Version&#34;&#34;: &#34;&#34;2012-10-17&#34;&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;&#34;Statement&#34;&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>        {
</span></span></span><span class=line><span class=cl><span class=s>            &#34;&#34;Effect&#34;&#34;: &#34;&#34;Allow&#34;&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;&#34;Principal&#34;&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>                &#34;&#34;Service&#34;&#34;: &#34;&#34;ecs-tasks.amazonaws.com&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>            },
</span></span></span><span class=line><span class=cl><span class=s>            &#34;&#34;Action&#34;&#34;: &#34;&#34;sts:AssumeRole&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>        }
</span></span></span><span class=line><span class=cl><span class=s>    ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>let policiy =
</span></span></span><span class=line><span class=cl><span class=s>    @&#34;</span><span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;&#34;</span><span class=n>Version</span><span class=s>&#34;&#34;</span><span class=o>:</span> <span class=s>&#34;&#34;</span><span class=n>2012</span><span class=o>-</span><span class=n>10</span><span class=o>-</span><span class=n>17</span><span class=s>&#34;&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;&#34;</span><span class=n>Statement</span><span class=s>&#34;&#34;</span><span class=o>:</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;&#34;</span><span class=n>Effect</span><span class=s>&#34;&#34;</span><span class=o>:</span> <span class=s>&#34;&#34;</span><span class=n>Allow</span><span class=s>&#34;&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;&#34;</span><span class=n>Action</span><span class=s>&#34;&#34;</span><span class=o>:</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;&#34;</span><span class=n>ssmmessages</span><span class=o>:</span><span class=n>CreateControlChannel</span><span class=s>&#34;&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;&#34;</span><span class=n>ssmmessages</span><span class=o>:</span><span class=n>CreateDataChannel</span><span class=s>&#34;&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;&#34;</span><span class=n>ssmmessages</span><span class=o>:</span><span class=n>OpenControlChannel</span><span class=s>&#34;&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;&#34;</span><span class=n>ssmmessages</span><span class=o>:</span><span class=n>OpenDataChannel</span><span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>],</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;&#34;</span><span class=n>Resource</span><span class=s>&#34;&#34;</span><span class=o>:</span> <span class=s>&#34;&#34;</span><span class=o>*</span><span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>taskPolicy</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>Policy</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;task-policy&#34;</span><span class=o>,</span> <span class=n>PolicyArgs</span><span class=o>(</span><span class=n>PolicyDocument</span> <span class=o>=</span> <span class=n>policiy</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>taskRole</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>Role</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>prefixMastodonResource</span> <span class=s>&#34;task-role&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>RoleArgs</span><span class=o>(</span><span class=n>AssumeRolePolicy</span> <span class=o>=</span> <span class=n>assumeRolePolicy</span><span class=o>,</span> <span class=n>ManagedPolicyArns</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>taskPolicy</span><span class=o>.</span><span class=n>Arn</span> <span class=o>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>defaultTaskRoleWithPolicy</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Awsx</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>DefaultRoleWithPolicyArgs</span><span class=o>(</span><span class=n>RoleArn</span> <span class=o>=</span> <span class=n>taskRole</span><span class=o>.</span><span class=n>Arn</span><span class=o>)</span>
</span></span></code></pre></div><p>The third step includes the Fargate service definition that uses the task definitions and ECS cluster that we defined in the previous steps using the simplified Fargate service definition from the <code>Awsx</code> package. We also see that we add the task role with the policy to the Fargate service definition only when the <code>RunMode</code> is set to <code>Maintenance</code> or <code>Debug</code>. We also define the network configuration for the Fargate service. Here we set the <code>AssignPublicIp</code> property to <code>true</code> so that the containers can be accessed from outside. To prevent the containers from being reachable from the outside, we set the ECS security group that we defined earlier in the section about the <a href=#vpc-and-security-groups>VPC and security groups</a>. Another property that is only set when <code>runMode</code> is set to <code>Maintenance</code> or <code>Debug</code> is the <code>EnableExecuteCommand</code> property, which is also needed to connect to the containers in the ECS cluster via the AWS Systems Manager Session Manager:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>fargateServiceTaskDefinitionArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>runMode</span> <span class=k>with</span> 
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>Maintenance</span> <span class=o>|</span> <span class=n>Debug</span> <span class=o>-&gt;</span> <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>FargateServiceTaskDefinitionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Containers</span> <span class=o>=</span> <span class=n>containerDefinitionsList</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>TaskRole</span> <span class=o>=</span> <span class=n>defaultTaskRoleWithPolicy</span>
</span></span><span class=line><span class=cl>            <span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>Production</span> <span class=o>-&gt;</span> <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=nn>Inputs</span><span class=p>.</span><span class=n>FargateServiceTaskDefinitionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Containers</span> <span class=o>=</span> <span class=n>containerDefinitionsList</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>networkConfiguration</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>ServiceNetworkConfigurationArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>AssignPublicIp</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Subnets</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>(</span><span class=n>defaultSubnetIds</span> <span class=o>|&gt;</span> <span class=nn>List</span><span class=p>.</span><span class=n>map</span> <span class=n>io</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=n>SecurityGroups</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>ecsSecurityGroup</span><span class=o>.</span><span class=n>Id</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>enableExecutCommand</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=n>runMode</span> <span class=k>with</span>
</span></span><span class=line><span class=cl>         <span class=o>|</span> <span class=n>Maintenance</span> <span class=o>|</span> <span class=n>Debug</span> <span class=o>-&gt;</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>         <span class=o>|</span> <span class=n>Production</span> <span class=o>-&gt;</span> <span class=n>fals</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>serviceArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=n>FargateServiceArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Cluster</span> <span class=o>=</span> <span class=n>cluster</span><span class=o>.</span><span class=n>Arn</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>DesiredCount</span> <span class=o>=</span> <span class=n>1</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>EnableExecuteCommand</span> <span class=o>=</span> <span class=n>enableExecutCommand</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>TaskDefinitionArgs</span> <span class=o>=</span> <span class=n>fargateServiceTaskDefinitionArgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>NetworkConfiguration</span> <span class=o>=</span> <span class=n>networkConfiguration</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nn>Awsx</span><span class=p>.</span><span class=nn>Ecs</span><span class=p>.</span><span class=n>FargateService</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;fargate-service&#34;</span><span class=o>,</span> <span class=n>serviceArgs</span><span class=o>)</span> <span class=o>|&gt;</span> <span class=n>ignore</span>
</span></span></code></pre></div><h3 id=s3-and-cloudfront>S3 and CloudFront</h3><p>An optional element, as described in the Mastodon documentation, is an object storage provider. Since we will be running Mastodon in Docker containers, we will need to use an external object storage provider, for which we will use AWS S3. In addition to the bucket itself, we will also create a CloudFront distribution to serve user-uploaded files from the S3 bucket. With the CloudFront distribution, we can also use a custom domain name to serve the files uploaded by the user. With the custom domain, we also don&rsquo;t have to worry about breaking the links to the user uploaded files if we change the object storage provider. Another advantage of using CloudFront is that we don&rsquo;t have to make the S3 bucket publicly available because we can restrict access to the S3 bucket to the CloudFront distribution.</p><h5 id=s3-bucket>S3 bucket</h5><p>In order for Mastodon to access the S3 bucket, we need to give Mastodon an AWS access key ID and an AWS access key ID secret. Since it&rsquo;s not entirely clear from the Mastodon documentation what permissions Mastodon needs to access the S3 bucket, I followed Daniel Snider&rsquo;s approach, which he describes in <a href="https://gist.github.com/ftpmorph/299c00907c827fbca883eeb45e6a7dc4?permalink_comment_id=4374053#gistcomment-4374053" rel="noopener noreferrer">this GitHub gist</a>. I also manually configured part of it in the AWS console. The parts I manually configured in the AWS console are creating the user <code>mastodon-s3-user</code> and adding that user to the <code>mastodon-s3-access-group</code> that we will create in the Pulumi deployment. I also created the access key and secret key for the <code>mastodon-s3-user</code> user and stored it in the AWS Secrets Manager.</p><p>First, we create the bucket and block public access to it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>bucket</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>bucketName</span> <span class=o>=</span> <span class=n>prefixMastodonResource</span> <span class=s>&#34;s3-storage&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>bucketArgs</span> <span class=o>=</span> <span class=n>BucketArgs</span><span class=o>(</span><span class=n>Acl</span> <span class=o>=</span> <span class=s>&#34;private&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Bucket</span><span class=o>(</span><span class=n>bucketName</span><span class=o>,</span> <span class=n>bucketArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>bucketPublicAccessBlock</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>bucketPublicAccessBlockArgs</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>        <span class=n>BucketPublicAccessBlockArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Bucket</span> <span class=o>=</span> <span class=n>bucket</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>BlockPublicAcls</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>BlockPublicPolicy</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>IgnorePublicAcls</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>RestrictPublicBuckets</span> <span class=o>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>BucketPublicAccessBlock</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;s3-storage-public-access-block&#34;</span><span class=o>,</span> <span class=n>bucketPublicAccessBlockArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>After that, we can create the S3 access group, a policy document, a policy and the policy attachment for this group:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>limitedPermissionsToOneBucketStatement</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>GetPolicyDocumentStatementInputArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Effect</span> <span class=o>=</span> <span class=s>&#34;Allow&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Actions</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;s3:ListBucket&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=s>&#34;s3:GetBucketLocation&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>        <span class=n>Resources</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>bucket</span><span class=o>.</span><span class=n>Arn</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>permissionsToBucketStatement</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>GetPolicyDocumentStatementInputArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Effect</span> <span class=o>=</span> <span class=s>&#34;Allow&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Actions</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;s3:GetObject&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=s>&#34;s3:GetObjectAcl&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=s>&#34;s3:PutObject&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=s>&#34;s3:PutObjectAcl&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=s>&#34;s3:DeleteObject&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=s>&#34;s3:AbortMultipartUpload&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=s>&#34;s3:ListMultipartUploadParts&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>        <span class=n>Resources</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>Format</span><span class=o>($</span><span class=s>&#34;{bucket.Arn}/*&#34;</span><span class=o>))</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>policyDocumentInvokeArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>GetPolicyDocumentInvokeArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Statements</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=n>limitedPermissionsToOneBucketStatement</span>
</span></span><span class=line><span class=cl>                        <span class=n>input</span> <span class=n>permissionsToBucketStatement</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>policyDocument</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nn>GetPolicyDocument</span><span class=p>.</span><span class=n>Invoke</span><span class=o>(</span><span class=n>policyDocumentInvokeArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>policyArgs</span> <span class=o>=</span> <span class=n>PolicyArgs</span><span class=o>(</span><span class=n>PolicyDocument</span> <span class=o>=</span> <span class=n>io</span> <span class=o>(</span><span class=n>policyDocument</span><span class=o>.</span><span class=n>Apply</span><span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>pd</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>Json</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>policy</span> <span class=o>=</span> <span class=n>Policy</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;s3-access-policiy&#34;</span><span class=o>,</span> <span class=n>policyArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>group</span> <span class=o>=</span> <span class=n>Group</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;s3-access-group&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>policyAttachmentArgs</span> <span class=o>=</span> <span class=n>PolicyAttachmentArgs</span><span class=o>(</span><span class=n>Groups</span> <span class=o>=</span> <span class=n>group</span><span class=o>.</span><span class=n>Name</span><span class=o>,</span> <span class=n>PolicyArn</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>Arn</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PolicyAttachment</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;access-group-policiy-attachment&#34;</span><span class=o>,</span> <span class=n>policyAttachmentArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>Now we can add the user <code>mastodon-s3-user</code> to the group <code>mastodon-s3-access-group</code> that we created above. This step is also done manually in the AWS console. From here, we just need to tell Mastodon the access key ID and the secret access key ID and we can store the files uploaded by the user in the S3 bucket.</p><h5 id=cloudfront-distribution>CloudFront distribution</h5><p>For the CloudFront distribution, we first define the origin access identity and a bucket policy for the S3 bucket so that we allow CloudFront to retrieve objects from the S3 bucket:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>originAccessIdentity</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>originAccessIdentityArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>OriginAccessIdentityArgs</span><span class=o>(</span><span class=n>Comment</span> <span class=o>=</span> <span class=s>&#34;Access identy to access the origin bucket&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>OriginAccessIdentity</span><span class=o>(</span><span class=s>&#34;Cloudfront Origin Access Identity&#34;</span><span class=o>,</span> <span class=n>originAccessIdentityArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>cloudFrontPrincipal</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>GetPolicyDocumentStatementPrincipalInputArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Type</span> <span class=o>=</span> <span class=s>&#34;AWS&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Identifiers</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>originAccessIdentity</span><span class=o>.</span><span class=n>IamArn</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span> <span class=nv>imageBucketPolicy</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>getObjectStatement</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>GetPolicyDocumentStatementInputArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Principals</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=n>cloudFrontPrincipal</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>            <span class=n>Actions</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;s3:GetObject&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>            <span class=n>Resources</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>inputList</span> <span class=o>[</span> <span class=n>io</span> <span class=n>bucket</span><span class=o>.</span><span class=n>Arn</span>
</span></span><span class=line><span class=cl>                            <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>Format</span><span class=o>($</span><span class=s>&#34;{bucket.Arn}/*&#34;</span><span class=o>))</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>policyDocumentInvokeArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>GetPolicyDocumentInvokeArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Statements</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=n>getObjectStatement</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>policyDocument</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=nn>GetPolicyDocument</span><span class=p>.</span><span class=n>Invoke</span><span class=o>(</span><span class=n>policyDocumentInvokeArgs</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>bucketPolicyArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>BucketPolicyArgs</span><span class=o>(</span><span class=n>Bucket</span> <span class=o>=</span> <span class=n>bucket</span><span class=o>.</span><span class=n>Id</span><span class=o>,</span> <span class=n>Policy</span> <span class=o>=</span> <span class=n>io</span> <span class=o>(</span><span class=n>policyDocument</span><span class=o>.</span><span class=n>Apply</span><span class=o>(</span><span class=k>fun</span> <span class=o>(</span><span class=n>pd</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>Json</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>BucketPolicy</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;image-bucket-policy&#34;</span><span class=o>,</span> <span class=n>bucketPolicyArgs</span><span class=o>)</span>
</span></span></code></pre></div><p>To support HTTPS, we also need to retrieve the certificate for the S3 alias host domain that we created using AWS Certificate Manager. For CloudFront, this certificate must be stored in the us-east-1 region:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>cert</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>certInvokeOptions</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>invokeOptions</span> <span class=o>=</span> <span class=n>InvokeOptions</span><span class=bp>()</span>
</span></span><span class=line><span class=cl>        <span class=n>invokeOptions</span><span class=o>.</span><span class=n>Provider</span> <span class=o>&lt;-</span> <span class=n>Provider</span><span class=o>(</span><span class=s>&#34;useast1&#34;</span><span class=o>,</span> <span class=n>ProviderArgs</span><span class=o>(</span><span class=n>Region</span> <span class=o>=</span> <span class=s>&#34;us-east-1&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=n>invokeOptions</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>getCertificateInvokeArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>GetCertificateInvokeArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Domain</span> <span class=o>=</span> <span class=n>s3AliasHost</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>MostRecent</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Types</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;AMAZON_ISSUED&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=nn>GetCertificate</span><span class=p>.</span><span class=n>Invoke</span><span class=o>(</span><span class=n>getCertificateInvokeArgs</span><span class=o>,</span> <span class=n>certInvokeOptions</span><span class=o>)</span>
</span></span></code></pre></div><p>Finally, we can create the CloudFront distribution with the certificate, the S3 alias host domain, and the S3 bucket as the origin:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>cloudFrontDistribution</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>s3OriginConfigArgs</span> <span class=o>=</span> <span class=n>DistributionOriginS3OriginConfigArgs</span><span class=o>(</span><span class=n>OriginAccessIdentity</span> <span class=o>=</span> <span class=n>originAccessIdentity</span><span class=o>.</span><span class=n>CloudfrontAccessIdentityPath</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>originArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionOriginArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>DomainName</span> <span class=o>=</span> <span class=n>bucket</span><span class=o>.</span><span class=n>BucketRegionalDomainName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>OriginId</span> <span class=o>=</span> <span class=s>&#34;myS3Origin&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>S3OriginConfig</span> <span class=o>=</span> <span class=n>s3OriginConfigArgs</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>viewerCertificate</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionViewerCertificateArgs</span><span class=o>(</span><span class=n>AcmCertificateArn</span> <span class=o>=</span> <span class=n>io</span> <span class=o>(</span><span class=n>cert</span><span class=o>.</span><span class=n>Apply</span><span class=o>(</span><span class=k>fun</span> <span class=n>cert</span> <span class=o>-&gt;</span> <span class=n>cert</span><span class=o>.</span><span class=n>Arn</span><span class=o>)),</span> <span class=n>SslSupportMethod</span> <span class=o>=</span> <span class=s>&#34;sni-only&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>forwardeValueCookies</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionDefaultCacheBehaviorForwardedValuesCookiesArgs</span><span class=o>(</span><span class=n>Forward</span> <span class=o>=</span> <span class=s>&#34;none&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>forwardedValuesArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionDefaultCacheBehaviorForwardedValuesArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>QueryString</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Cookies</span> <span class=o>=</span> <span class=n>forwardeValueCookies</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>defaultCacheBehaviorArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionDefaultCacheBehaviorArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>AllowedMethods</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;GET&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=n>input</span> <span class=s>&#34;HEAD&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=n>input</span> <span class=s>&#34;OPTIONS&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>            <span class=n>CachedMethods</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span> <span class=n>input</span> <span class=s>&#34;GET&#34;</span><span class=o>;</span> <span class=n>input</span> <span class=s>&#34;HEAD&#34;</span> <span class=o>],</span>
</span></span><span class=line><span class=cl>            <span class=n>TargetOriginId</span> <span class=o>=</span> <span class=s>&#34;myS3Origin&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ForwardedValues</span> <span class=o>=</span> <span class=n>forwardedValuesArgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ViewerProtocolPolicy</span> <span class=o>=</span> <span class=s>&#34;redirect-to-https&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>MinTtl</span> <span class=o>=</span> <span class=n>100</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>DefaultTtl</span> <span class=o>=</span> <span class=n>3600</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>MaxTtl</span> <span class=o>=</span> <span class=n>86400</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>SmoothStreaming</span> <span class=o>=</span> <span class=k>false</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Compress</span> <span class=o>=</span> <span class=k>true</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>geoRestrictions</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionRestrictionsGeoRestrictionArgs</span><span class=o>(</span><span class=n>RestrictionType</span> <span class=o>=</span> <span class=s>&#34;none&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>restrictionArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionRestrictionsArgs</span><span class=o>(</span><span class=n>GeoRestriction</span> <span class=o>=</span> <span class=n>geoRestrictions</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>cloudFrontDistributionArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>DistributionArgs</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Origins</span> <span class=o>=</span> <span class=n>originArgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Enabled</span> <span class=o>=</span> <span class=k>true</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Aliases</span> <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span><span class=n>input</span> <span class=n>s3AliasHost</span><span class=o>],</span>
</span></span><span class=line><span class=cl>            <span class=n>Comment</span> <span class=o>=</span> <span class=s>&#34;Distribution as S3 alias for Mastodon content delivery&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>DefaultRootObject</span> <span class=o>=</span> <span class=s>&#34;index.html&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>PriceClass</span> <span class=o>=</span> <span class=s>&#34;PriceClass_100&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ViewerCertificate</span> <span class=o>=</span> <span class=n>viewerCertificate</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>DefaultCacheBehavior</span> <span class=o>=</span> <span class=n>defaultCacheBehaviorArgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Restrictions</span> <span class=o>=</span> <span class=n>restrictionArgs</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Distribution</span><span class=o>(</span><span class=n>prefixMastodonResource</span> <span class=s>&#34;media-distribution&#34;</span><span class=o>,</span> <span class=n>cloudFrontDistributionArgs</span><span class=o>)</span>
</span></span></code></pre></div><h3 id=configuration-and-secrets>Configuration and secrets</h3><p>In the previous section, we created a lot of resources that need to be configured in the Mastodon configuration. I created the namespace <code>MastodonAwsServices.Configuration</code> which contains the following modules:</p><ul><li>Secrets -> provides a function to retrieve secrets from the AWS Secrets Manager.</li><li>Configuration -> provides a function to retrieve configuration values from the AWS Systems Manager Parameter Store</li><li>Values -> provides all configuration values for the Mastodon instance and AWS resources.</li></ul><p>The Secrets and Configuration modules are very similar. They both provide a function that retrieves a value from AWS. The only difference is that the Secrets module retrieves the value from the AWS Secrets Manager and the Configuration module retrieves the value from the AWS Systems Manager Parameter Store.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>module</span> <span class=nn>Secrets</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Amazon.SecretsManager</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Amazon.SecretsManager.Model</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>System.Threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>getSecret</span> <span class=o>(</span><span class=n>secretName</span><span class=o>:</span> <span class=kt>string</span><span class=o>)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>awsSecretManagerClient</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AmazonSecretsManagerClient</span><span class=bp>()</span>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>mutable</span> <span class=n>secretValueRequest</span> <span class=o>=</span> <span class=n>GetSecretValueRequest</span><span class=bp>()</span>
</span></span><span class=line><span class=cl>        <span class=n>secretValueRequest</span><span class=o>.</span><span class=n>SecretId</span> <span class=o>&lt;-</span> <span class=n>secretName</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>asyncSecret</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>async</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>let!</span> <span class=nv>result</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                    <span class=n>awsSecretManagerClient</span><span class=o>.</span><span class=n>GetSecretValueAsync</span><span class=o>(</span><span class=n>secretValueRequest</span><span class=o>,</span> <span class=n>CancellationToken</span><span class=o>(</span><span class=k>false</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>secretResponse</span> <span class=o>=</span> <span class=nn>Async</span><span class=p>.</span><span class=n>RunSynchronously</span><span class=o>(</span><span class=n>asyncSecret</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>secretResponse</span><span class=o>.</span><span class=n>SecretString</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=nn>Params</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Amazon.SimpleSystemsManagement</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Amazon.SimpleSystemsManagement.Model</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>System.Threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>getParameter</span> <span class=o>(</span><span class=n>parameterName</span><span class=o>:</span> <span class=kt>string</span><span class=o>)</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>client</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AmazonSimpleSystemsManagementClient</span><span class=bp>()</span>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>mutable</span> <span class=n>parameterRequest</span> <span class=o>=</span> <span class=n>GetParameterRequest</span><span class=bp>()</span>
</span></span><span class=line><span class=cl>        <span class=n>parameterRequest</span><span class=o>.</span><span class=n>Name</span> <span class=o>&lt;-</span> <span class=n>parameterName</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>asyncParameter</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>async</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>let!</span> <span class=nv>result</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                    <span class=n>client</span><span class=o>.</span><span class=n>GetParameterAsync</span><span class=o>(</span><span class=n>parameterRequest</span><span class=o>,</span> <span class=n>CancellationToken</span><span class=o>(</span><span class=k>false</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=o>|&gt;</span> <span class=nn>Async</span><span class=p>.</span><span class=n>AwaitTask</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>let</span> <span class=nv>parameterResponse</span> <span class=o>=</span> <span class=nn>Async</span><span class=p>.</span><span class=n>RunSynchronously</span><span class=o>(</span><span class=n>asyncParameter</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>parameterResponse</span><span class=o>.</span><span class=n>Parameter</span><span class=o>.</span><span class=n>Value</span>
</span></span></code></pre></div><p>The Values module contains all the configuration values for the Mastodon instance and AWS resources. The values are retrieved from AWS Secrets Manager and AWS Systems Manager Parameter Store.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>module</span> <span class=nn>Values</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Secrets</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Params</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Pulumi</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Pulumi.Awsx.Ecs.Inputs</span>
</span></span><span class=line><span class=cl>    <span class=k>open</span> <span class=nn>Pulumi.FSharp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>type</span> <span class=nc>RunMode</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>Production</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>Maintenance</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>Debug</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>runMode</span> <span class=o>=</span> <span class=n>Production</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>awsConfig</span> <span class=o>=</span> <span class=n>Config</span><span class=o>(</span><span class=s>&#34;aws&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>mastodonImage</span> <span class=o>=</span> <span class=s>&#34;tootsuite/mastodon:v4.1.2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Pulumi
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>mastodonResourcePrefix</span> <span class=o>=</span> <span class=s>&#34;mastodon-&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>prefixMastodonResource</span> <span class=n>resourceNameToPrefix</span><span class=o>=</span> <span class=n>mastodonResourcePrefix</span> <span class=o>+</span> <span class=n>resourceNameToPrefix</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RDS
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>rdsDbMasterPassword</span><span class=o>=</span> <span class=n>getSecret</span><span class=s>&#34;mastodon/rds/db-master-password&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon federatiom
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>localDomain</span> <span class=o>=</span> <span class=s>&#34;social.simonschoof.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>singleUserMode</span> <span class=o>=</span> <span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>defaultLocale</span><span class=o>=</span><span class=s>&#34;en&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>alternateDomains</span> <span class=o>=</span> <span class=s>&#34;&#34;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon secrets
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>secretKeyBase</span><span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/secrets/secret-key-base&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>otpSecret</span> <span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/secrets/otp-secret&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>vapIdPrivateKey</span> <span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/secrets/vapid-private-key&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>vapIdPublicKey</span> <span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/secrets/vapid-public-key&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon deployment
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>railsEnv</span> <span class=o>=</span> <span class=s>&#34;production&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>railsServeStaticFiles</span> <span class=o>=</span> <span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>railsLogLevel</span> <span class=o>=</span> <span class=s>&#34;warn&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>nodeEnv</span> <span class=o>=</span> <span class=s>&#34;production&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon postgres
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>dbHost</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/postgres/db-host&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>dbUser</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/postgres/db-user&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>dbName</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/postgres/db-name&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>dbPass</span> <span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/postgres/db-pass&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon redis
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>redisHost</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/redis/redis-host&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon email
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>stmpServer</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/mail/smtp-server&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpPort</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/mail/smtp-port&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpLogin</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/mail/smtp-login&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpPassword</span> <span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/mail/smtp-password&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpFromAddress</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/mail/smtp-from-address&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpDomain</span><span class=o>=</span> <span class=s>&#34;social.simonschoof.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpAuthMethod</span> <span class=o>=</span> <span class=s>&#34;plain&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpOpenSslVerifyMode</span> <span class=o>=</span> <span class=s>&#34;none&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>smtpEnableStarttls</span> <span class=o>=</span> <span class=s>&#34;auto&#34;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon Amazon S3 and compatible
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>s3AliasHost</span> <span class=o>=</span> <span class=s>&#34;mastodonmedia.simonschoof.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>s3Enabled</span><span class=o>=</span> <span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>s3Bucket</span> <span class=o>=</span>  <span class=n>getParameter</span> <span class=s>&#34;/mastodon/s3/bucket&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>awsAccessKeyId</span> <span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/s3/aws-access-key-id&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>awsSecretAccessKey</span> <span class=o>=</span> <span class=n>getSecret</span> <span class=s>&#34;mastodon/s3/aws-secret-access-key&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>s3Region</span> <span class=o>=</span> <span class=n>awsConfig</span><span class=o>.</span><span class=n>Require</span><span class=o>(</span><span class=s>&#34;region&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>s3Protocol</span> <span class=o>=</span> <span class=s>&#34;HTTPS&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>let</span> <span class=nv>s3Hostname</span> <span class=o>=</span> <span class=n>getParameter</span> <span class=s>&#34;/mastodon/s3/hostname&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Mastodon other
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>let</span> <span class=nv>skipPostDeploymentMigrations</span> <span class=o>=</span> <span class=s>&#34;true&#34;</span>
</span></span></code></pre></div><p>Finally, we need a list of <code>TaskDefinitionKeyValuePairArgs</code> that we can use to configure the Mastodon containers. For the secret values, we use Pulumi&rsquo;s <a href=https://www.pulumi.com/docs/concepts/secrets/ rel="noopener noreferrer">Output.CreateSecret</a> function so that the secret is not logged during deployment and masked in the Pulumi state file. By using the <code>Output.CreateSecret</code> function once in the definition of the list, the entire list will be classified as secret in the Pulumi state file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fsharp data-lang=fsharp><span class=line><span class=cl><span class=k>let</span> <span class=nv>mastodonContainerEnvVariables</span>  <span class=o>=</span> <span class=n>inputList</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;LOCAL_DOMAIN&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>localDomain</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SINGLE_USER_MODE&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>singleUserMode</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;DEFAULT_LOCALE&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>defaultLocale</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SECRET_KEY_BASE&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>secretKeyBase</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;OTP_SECRET&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>otpSecret</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;VAPID_PRIVATE_KEY&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>vapIdPrivateKey</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;VAPID_PUBLIC_KEY&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>vapIdPublicKey</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;RAILS_ENV&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>railsEnv</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;RAILS_SERVE_STATIC_FILES&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>railsServeStaticFiles</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;RAILS_LOG_LEVEL&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>railsLogLevel</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;NODE_ENV&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>nodeEnv</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;DB_HOST&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>dbHost</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;DB_USER&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>dbUser</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;DB_NAME&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>dbName</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;DB_PASS&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>dbPass</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;REDIS_HOST&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>redisHost</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_SERVER&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>stmpServer</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_PORT&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpPort</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_LOGIN&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpLogin</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_PASSWORD&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpPassword</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_FROM_ADDRESS&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpFromAddress</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_DOMAIN&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpDomain</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_AUTH_METHOD&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpAuthMethod</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_OPENSSL_VERIFY_MODE&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpOpenSslVerifyMode</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SMTP_ENABLE_STARTTLS&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>smtpEnableStarttls</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;S3_ALIAS_HOST&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>s3AliasHost</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;S3_ENABLED&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>s3Enabled</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;S3_BUCKET&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>s3Bucket</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;AWS_ACCESS_KEY_ID&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>awsAccessKeyId</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>(</span><span class=nn>Output</span><span class=p>.</span><span class=n>CreateSecret</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;AWS_SECRET_ACCESS_KEY&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>awsSecretAccessKey</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;S3_REGION&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>s3Region</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;S3_PROTOCOL&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>s3Protocol</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;S3_HOSTNAME&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>s3Hostname</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;S3_PERMISSION&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span> <span class=o>(</span><span class=n>TaskDefinitionKeyValuePairArgs</span><span class=o>(</span><span class=n>Name</span> <span class=o>=</span> <span class=s>&#34;SKIP_POST_DEPLOYMENT_MIGRATIONS&#34;</span><span class=o>,</span> <span class=n>Value</span> <span class=o>=</span> <span class=n>skipPostDeploymentMigrations</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></div><h3 id=spin-up-the-mastodon-instance>Spin up the Mastodon instance</h3><p>Now that we have set up all the infrastructure code and manually prepared the <a href=#domain-name-and-certificates>domain name and certificates</a>, <a href=#ses>SES</a> and the <a href=#s3-bucket>access to the S3 bucket</a>, we can deploy our own Mastodon instance. We just need to call <code>pulumi up</code>, wait for the deployment to complete and voi la we have our own Mastodon instance running on AWS.</p><p>You can find my instance at <a href=https://social.simonschoof.com rel="noopener noreferrer">social.simonschoof.com</a>. If you want to deploy your own instance, you can find the code for the infrastructure in the <a href=https://github.com/simonschoof/mastodon-aws/tree/main/infrastructure/aws-services rel="noopener noreferrer">aws-services</a> folder.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>There are 3 subnets in the default VPC for the <code>eu-central-1</code> region. One public subnet in each availability zone. I tried to get the number of subnets out of the Output of the <code>GetSubnets</code> Invoke but I did not find a way to do it. So I just hardcoded the number of subnets to 3.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>The security group for the PostgreSQL database is called <code>rdsSecurityGroup</code> because we use the <a href=https://docs.aws.amazon.com/rds/index.html rel="noopener noreferrer">RDS service</a> from AWS with the Aurora Serverless v2 engine, which is compatible with PostgreSQL.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>To be able to test and debug the application, I added a configuration type with three states: <code>type RunMode = | Production | Maintenance | Debug</code>. When the <code>RunMode</code> is set to <code>Maintenace</code> or <code>Debug</code>, an additional PostgreSQL container is created. From the PostgreSQL container the PostgreSQL database can be accessed. To get access to PostgreSQL and the other containers directly from my shell, I use <a href=https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-exec.html rel="noopener noreferrer">AWS ECS Exec</a>. In order for AWS ECS Exec to work, I had to install the AWS CLI and the AWS Session Manager plugin on my machine. I also had to <a href=#container-task-definitions>add an IAM role</a> to allow communication between the containers and the managed SSM agent. As a final step, I had to set the <code>ExecuteCommmand</code> flag in the <a href=#ecs-with-fargate>ESC service definition</a>. After that, you can execute commands on your containers using <code>aws ecs execute-command</code>. You can use the <a href=https://github.com/aws-containers/amazon-ecs-exec-checker rel="noopener noreferrer">AWS ECS Exec Checker</a> to check if everything is configured correctly to access the containers.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>While it does indeed save some money, it also reduces the availability of the service since I only run one instance of each container in the ECS task.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><footer><span class=copyright>Build with <a href=https://gohugo.io/ title=hugo alt=hugo target=_blank>hugo</a> & <span class=emojify>‚ù§Ô∏è</span>
| Theme: Based on <a href=https://github.com/aanupam23/hugo-sugoi title=hugo-sugoi alt=hugo-sugoi target=_blank>hugo-sugoi</a>
extended by <a href=https://github.com/simonschoof/hugo-sugoi title="my theme" alt="my theme" target=_blank>me</a>.<br>&copy; 2024 Simon Schoof
| <a href=https://simonschoof.com/imprint title=Imprint alt=Imprint>Imprint</a>
| <a href=https://simonschoof.com/privacy title=Privacy alt=Privacy>Privacy</a>
| <a rel=me href=https://social.simonschoof.com/@connect></a></span></footer></body></html>